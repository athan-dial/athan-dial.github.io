---
phase: 07-enrichment-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - ~/n8n-data/workflows/enrichment-pipeline.json
  - ~/model-citizen-vault/.enrichment/logs/.gitkeep
autonomous: true

must_haves:
  truths:
    - "n8n workflow can trigger enrichment for a source file"
    - "n8n checks enrichment status before processing (skip if already enriched)"
    - "n8n runs summarization first, then tagging + ideas in parallel"
    - "n8n logs enrichment results and updates source status"
    - "Backfill requires manual trigger (no automatic batch)"
  artifacts:
    - path: "~/n8n-data/workflows/enrichment-pipeline.json"
      provides: "Importable n8n workflow for full enrichment pipeline"
    - path: "~/model-citizen-vault/.enrichment/logs/.gitkeep"
      provides: "Logs directory tracked in git"
  key_links:
    - from: "n8n enrichment workflow"
      to: "scripts/enrich-source.sh"
      via: "SSH Execute Command node"
      pattern: "enrich-source\\.sh"
    - from: "n8n enrichment workflow"
      to: "source frontmatter status field"
      via: "pre-check node reads status before processing"
      pattern: "status.*enriched"
---

<objective>
Create the n8n workflow that orchestrates enrichment via SSH, connecting the Phase 6 integration layer to the Phase 7 enrichment scripts.

Purpose: n8n provides the trigger and monitoring layer -- it decides WHEN to enrich, invokes the pipeline via SSH, and tracks completion.
Output: Importable n8n workflow JSON that triggers enrichment for new sources.
</objective>

<execution_context>
@/Users/adial/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adial/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-claude-code-integration/06-02-SUMMARY.md
@.planning/phases/07-enrichment-pipeline/07-CONTEXT.md
@.planning/phases/07-enrichment-pipeline/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create n8n enrichment workflow</name>
  <files>
    ~/n8n-data/workflows/enrichment-pipeline.json
    ~/model-citizen-vault/.enrichment/logs/.gitkeep
  </files>
  <action>
    Create an importable n8n workflow JSON file that orchestrates the enrichment pipeline.

    **Workflow nodes:**

    1. **Manual Trigger** node: Accepts `sourcePath` parameter (path to source file in vault). This is the entry point -- triggered manually or by future automation.

    2. **Check Status** (SSH Execute Command): Run `grep "^status:" <sourcePath> | head -1` via SSH to check if source is already enriched. Uses same SSH credentials from Phase 6 (key: `~/.ssh/n8n_docker`, host: `host.docker.internal`, user: `adial`).

    3. **IF Not Enriched** (IF node): Check if status output does NOT contain "enriched". If already enriched, go to "Skip" node. If not, proceed to enrichment.

    4. **Run Enrichment** (SSH Execute Command): Execute `~/model-citizen-vault/scripts/enrich-source.sh --source {{sourcePath}} --verbose` via SSH. Set timeout to 900s (15 min, since pipeline runs multiple Claude invocations).

    5. **Parse Results** (Function node): Parse SSH output to extract:
       - Whether enrichment succeeded (exit code 0), partial (exit code 1), or failed (exit code 2)
       - Summary text (for logging)
       - Number of idea cards generated
       - Any quality flags triggered

    6. **Log Results** (Function node): Append to daily log. Format a log line and write via SSH: `echo "$(date) | {{sourceName}} | {{status}} | {{ideaCount}} ideas | {{flags}}" >> ~/model-citizen-vault/.enrichment/logs/.enrichment-daily-$(date +%Y-%m-%d).md`

    7. **Skip** (NoOp node): Endpoint for already-enriched sources.

    **SSH configuration** (reuse Phase 6 pattern):
    - Host: `host.docker.internal`
    - Port: 22
    - User: `adial`
    - Private Key: contents of `~/.ssh/n8n_docker`
    - All commands use full paths

    **Also create** `.enrichment/logs/.gitkeep` to ensure logs directory is tracked in git.

    **Workflow metadata:**
    - Name: "Model Citizen - Enrichment Pipeline"
    - Tags: ["model-citizen", "enrichment"]

    Reference the Phase 6 n8n workflow (`~/n8n-data/workflows/claude-code-ssh-test.json`) for SSH node configuration patterns.
  </action>
  <verify>
    - Workflow JSON is valid: `python3 -c "import json; json.load(open('$HOME/n8n-data/workflows/enrichment-pipeline.json'))"`
    - JSON contains expected node names: Manual Trigger, Check Status, IF Not Enriched, Run Enrichment, Parse Results, Log Results
    - `.enrichment/logs/.gitkeep` exists in vault
  </verify>
  <done>
    Importable n8n workflow ready for enrichment orchestration. Handles status pre-check, SSH-based enrichment invocation, result parsing, and daily logging.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integration test via n8n workflow</name>
  <files></files>
  <action>
    Test the full n8n -> SSH -> enrichment pipeline integration.

    1. **Create fresh test source**: Create `~/model-citizen-vault/sources/test/n8n-enrichment-test.md` with:
       - Frontmatter: `title: "n8n Integration Test"`, `status: ingested`, `source_type: youtube`
       - Body: 300-500 words of sample content (different from Plan 01 test)

    2. **Import workflow**: Provide instructions for importing `enrichment-pipeline.json` into n8n (via n8n UI or API).

    3. **If n8n is running**: Test the workflow by triggering it with the test source path. Verify:
       - Status pre-check works (proceeds because `status: ingested`)
       - Enrichment script runs via SSH
       - Source file gets `status: enriched` with all metadata fields
       - Idea cards created in `ideas/`
       - Daily log updated

    4. **If n8n is NOT running or SSH auth not configured**: Document the manual test steps and verify the workflow JSON is structurally correct by:
       - Validating JSON structure
       - Checking all SSH node configs reference correct host/user/key
       - Running `enrich-source.sh` directly on the test source to confirm pipeline works
       - Documenting what user needs to do: start n8n Docker, import workflow, configure SSH credentials, test trigger

    5. **Test idempotency via n8n**: If possible, re-trigger workflow for same source and verify "Skip" path is taken.

    The primary goal is ensuring the n8n workflow JSON is correct and the enrichment script works end-to-end. If SSH/n8n aren't available in this session, direct script testing is sufficient with clear documentation for n8n integration.
  </action>
  <verify>
    - Test source file exists and has been enriched (or script ran successfully on it)
    - n8n workflow JSON validates and contains all required nodes
    - Integration path documented (SSH credentials, n8n import steps)
  </verify>
  <done>
    n8n enrichment workflow tested (or validated structurally if n8n unavailable). Pipeline proven: source -> enrichment -> metadata + ideas + log. Documentation covers setup steps for production use.
  </done>
</task>

</tasks>

<verification>
- n8n workflow JSON is valid and importable
- Workflow handles: status check, enrichment trigger, result parsing, logging
- SSH configuration matches Phase 6 patterns
- End-to-end integration tested or documented for user testing
</verification>

<success_criteria>
1. n8n workflow JSON exists and is importable
2. Workflow correctly checks source status before processing
3. Workflow invokes enrich-source.sh via SSH with correct parameters
4. Results are parsed and logged to daily enrichment log
5. Already-enriched sources are skipped (idempotent)
</success_criteria>

<output>
After completion, create `.planning/phases/07-enrichment-pipeline/07-02-SUMMARY.md`
</output>
