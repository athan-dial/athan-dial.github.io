---
phase: 07-enrichment-pipeline
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/model-citizen-vault/scripts/enrich-source.sh
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Running enrich-source.sh on a source populates tags (5-10), quotes (2-3), and takeaways (3-5) in frontmatter"
    - "Running enrich-source.sh creates 2-3 idea card files in ideas/ directory"
    - "After enrichment completes, source status is updated to 'enriched' and daily log entry is created"
  artifacts:
    - path: "~/model-citizen-vault/sources/test/n8n-enrichment-test.md"
      provides: "Frontmatter with populated tags, quotes, takeaways arrays"
      contains: "status: enriched"
    - path: "~/model-citizen-vault/ideas/"
      provides: "2-3 idea card files generated from test source"
  key_links:
    - from: "enrich-source.sh tagging extraction"
      to: "source frontmatter tags/quotes/takeaways"
      via: "update-frontmatter.py"
      pattern: "tags.*\\[.*\\]"
    - from: "enrich-source.sh idea generation"
      to: "ideas/ directory"
      via: "file creation from Claude output"
    - from: "enrich-source.sh finalization"
      to: "source status field"
      via: "update-frontmatter.py --field status --value enriched"
---

<objective>
Fix three enrichment pipeline bugs: tagging extraction produces empty arrays, idea card files are never created, and finalization step has command syntax error.

Purpose: Phase 7 verification found only 1/4 enrichment types working (summaries). This closes the remaining gaps so the full pipeline delivers tags, quotes, takeaways, idea cards, and status updates.

Output: Working enrich-source.sh that produces complete enrichment output on test source.
</objective>

<execution_context>
@/Users/adial/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adial/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/07-enrichment-pipeline/07-01-SUMMARY.md
@.planning/phases/07-enrichment-pipeline/07-VERIFICATION.md
@~/model-citizen-vault/scripts/enrich-source.sh
@~/model-citizen-vault/scripts/update-frontmatter.py
@~/model-citizen-vault/.enrichment/prompts/tagging.md
@~/model-citizen-vault/.enrichment/prompts/ideas.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix tagging extraction and idea card creation in enrich-source.sh</name>
  <files>~/model-citizen-vault/scripts/enrich-source.sh</files>
  <action>
Debug and fix three bugs in enrich-source.sh:

**Bug 1: Tagging extraction produces empty arrays**
- The tagging task invokes Claude and gets a response, but the parsing logic fails to extract tags/quotes/takeaways from Claude's output
- Root cause is likely in the YAML/JSON extraction section that processes Claude's tagging response
- Inspect the `extract_tagging_data` or equivalent function — the state-based AWK parser may not match Claude's actual output format
- Fix: Ensure the extraction handles Claude's actual output (which may be wrapped in markdown fences, use different YAML formatting, or return JSON instead of YAML)
- After extraction, verify update-frontmatter.py is called with correct arguments to merge tags, quotes, and takeaways into frontmatter

**Bug 2: Idea card files never created**
- The ideas task invokes Claude and gets a response, but no files are written to ideas/ directory
- Inspect the idea card creation section — likely the script parses Claude's idea output but the file-writing logic has a bug (wrong path, failed JSON parsing, or conditional that never triggers)
- Fix: Ensure each idea from Claude's response gets written as a separate markdown file in ~/model-citizen-vault/ideas/ with format: {source-basename}-idea-{N}.md
- Each idea file needs frontmatter (source, created, status: idea, tags) and body (title, outline, rationale, vault connections)

**Bug 3: Finalization command syntax error**
- The line calling update-frontmatter.py to set status=enriched has incorrect parameters
- Fix: Change to use `--field status --value enriched` (or whatever the correct parameter syntax is per update-frontmatter.py's argparse interface)
- Also fix the daily log creation that is blocked by the same finalization step

Test approach: After fixing, reset the test source to status=ingested with empty arrays, then run the enrichment script manually:
```bash
# Reset test source
cd ~/model-citizen-vault
python scripts/update-frontmatter.py sources/test/n8n-enrichment-test.md --field status --value ingested
# Clear any previous idea cards
rm -f ideas/n8n-enrichment-test-idea-*.md
# Run enrichment
bash scripts/enrich-source.sh sources/test/n8n-enrichment-test.md
```
  </action>
  <verify>
After running enrich-source.sh on the test source:
1. `grep "^tags:" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md` shows non-empty array
2. `grep "^quotes:" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md` shows non-empty array
3. `grep "^takeaways:" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md` shows non-empty array
4. `ls ~/model-citizen-vault/ideas/n8n-enrichment-test-idea-*.md` shows 2-3 files
5. `grep "^status:" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md` shows "enriched"
6. `ls ~/model-citizen-vault/.enrichment/logs/` shows daily log file
  </verify>
  <done>
All three enrichment outputs working: tags/quotes/takeaways populated in frontmatter, idea card files created in ideas/ directory, status updated to "enriched" and daily log entry created.
  </done>
</task>

</tasks>

<verification>
Run full enrichment on test source and verify all outputs:
```bash
# Check frontmatter has populated fields
grep -E "^(tags|quotes|takeaways|status):" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md

# Check idea cards exist
ls -la ~/model-citizen-vault/ideas/n8n-enrichment-test-idea-*.md

# Check daily log
ls ~/model-citizen-vault/.enrichment/logs/.enrichment-daily-*.md
```

All must show non-empty, populated values.
</verification>

<success_criteria>
1. tags array has 5-10 entries (not empty [])
2. quotes array has 2-3 entries (not empty [])
3. takeaways array has 3-5 entries (not empty [])
4. ideas/ directory has 2-3 idea card files with proper frontmatter and body content
5. Source status is "enriched" (not "ingested")
6. Daily enrichment log exists with entry for this run
</success_criteria>

<output>
After completion, create `.planning/phases/07-enrichment-pipeline/07-03-SUMMARY.md`
</output>
