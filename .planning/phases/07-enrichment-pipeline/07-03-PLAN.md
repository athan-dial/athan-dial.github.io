---
phase: 07-enrichment-pipeline
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/model-citizen-vault/scripts/enrich-source.sh
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Running enrich-source.sh on a source populates tags (5-10), quotes (2-3), and takeaways (3-5) in frontmatter"
    - "Running enrich-source.sh creates 2-3 idea card files in ideas/ directory"
    - "After enrichment completes, source status is updated to 'enriched' and daily log entry is created"
  artifacts:
    - path: "~/model-citizen-vault/sources/test/n8n-enrichment-test.md"
      provides: "Frontmatter with populated tags, quotes, takeaways arrays"
      contains: "status: enriched"
    - path: "~/model-citizen-vault/ideas/"
      provides: "2-3 idea card files generated from test source"
  key_links:
    - from: "enrich-source.sh tagging extraction"
      to: "source frontmatter tags/quotes/takeaways"
      via: "update-frontmatter.py --json-file"
      pattern: "tags.*\\[.*\\]"
    - from: "enrich-source.sh idea generation"
      to: "ideas/ directory"
      via: "file creation from Claude output (lines 397-466)"
    - from: "enrich-source.sh finalization"
      to: "source status field"
      via: "update-frontmatter.py --field status --value enriched"
---

<objective>
Fix three enrichment pipeline bugs: tagging extraction produces empty arrays, idea card files are never created, and finalization step has command syntax error.

Purpose: Phase 7 verification found only 1/4 enrichment types working (summaries). This closes the remaining gaps so the full pipeline delivers tags, quotes, takeaways, idea cards, and status updates.

Output: Working enrich-source.sh that produces complete enrichment output on test source.
</objective>

<execution_context>
@/Users/adial/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adial/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/07-enrichment-pipeline/07-01-SUMMARY.md
@.planning/phases/07-enrichment-pipeline/07-VERIFICATION.md
@~/model-citizen-vault/scripts/enrich-source.sh
@~/model-citizen-vault/scripts/update-frontmatter.py
@~/model-citizen-vault/scripts/claude-task-runner.sh
@~/model-citizen-vault/.enrichment/prompts/tagging.md
@~/model-citizen-vault/.enrichment/prompts/ideas.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix tagging extraction parsing logic</name>
  <files>~/model-citizen-vault/scripts/enrich-source.sh</files>
  <action>
Fix the tagging extraction section (lines 334-391) that parses Claude's tagging output into tags/quotes/takeaways.

**Diagnosis approach:** First inspect a real tagging output file to understand what Claude actually returns. Check:
```bash
ls ~/model-citizen-vault/.model-citizen/outputs/enrich-tagging-*.json 2>/dev/null | tail -1
cat <that file>
```

The claude-task-runner.sh (line 182) invokes Claude with `--output-format text` and pipes the raw response to the output file. On line 191-205, it strips markdown code fences and checks for JSON validity — if valid JSON, it saves as-is; if not, it saves the raw text anyway.

**Two possible root causes (inspect actual output to determine which):**

1. **Claude returns valid JSON** but the JSON path on line 341 (`jq -e '.tags'`) doesn't match the actual JSON structure. Fix: adjust jq path to match actual structure.

2. **Claude returns YAML/text** but the AWK parser (lines 351-373) doesn't match the actual format. The AWK expects exactly `^  - ` (two-space indent) after `^tags:`, `^quotes:`, `^takeaways:` headers. If Claude uses different indentation, wraps in code fences the sed didn't strip, or uses `- ` without leading spaces, the extraction silently produces empty strings.

**If neither output file exists** (first run didn't save), the prompt structure may need adjustment. Per CONTEXT.md, prompt structure is within Claude's discretion. Check `~/model-citizen-vault/.enrichment/prompts/tagging.md` — ensure it asks Claude to output in a format the parser can handle. Either:
- Adjust the prompt to request JSON output matching `{"tags": [...], "quotes": [...], "takeaways": [...]}`, OR
- Fix the AWK parser to handle whatever format the prompt currently requests

**After fixing extraction:** Verify that `update-frontmatter.py --source <file> --json-file <json>` is called correctly on line 386. The JSON file must contain valid JSON with tags/quotes/takeaways as arrays.
  </action>
  <verify>
Run a tagging extraction test on the test source (or inspect existing output):
```bash
# Check if tagging output exists from previous run
ls ~/model-citizen-vault/.model-citizen/outputs/enrich-tagging-n8n-enrichment-test-*.json 2>/dev/null
# If it does, verify the extraction logic produces valid JSON
```
After full pipeline run (Task 3 verify), confirm:
- `grep "^tags:" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md` shows non-empty array
- `grep "^quotes:" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md` shows non-empty array
- `grep "^takeaways:" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md` shows non-empty array
  </verify>
  <done>
Tagging extraction correctly parses Claude's output format and populates tags, quotes, and takeaways arrays in source frontmatter via update-frontmatter.py.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix idea card file creation logic</name>
  <files>~/model-citizen-vault/scripts/enrich-source.sh</files>
  <action>
Fix the idea card creation section (lines 397-466) that should write idea cards to ~/model-citizen-vault/ideas/.

**Diagnosis approach:** First inspect a real ideas output file:
```bash
ls ~/model-citizen-vault/.model-citizen/outputs/enrich-ideas-*.json 2>/dev/null | tail -1
cat <that file>
```

**The file-writing logic has two paths (lines 400-466):**

1. **Structured JSON path (lines 401-438):** Checks `jq -e '.generated_ideas'` — if Claude returns JSON with a `generated_ideas` array, it iterates and writes files. This likely fails because claude-task-runner saves raw text, not structured JSON with that specific key.

2. **Markdown fallback path (lines 442-462):** Tries `jq -r '.ideas // .summary // .content // .response // empty'` — this also likely fails on non-JSON output. Even if it extracts content, the AWK parser on line 446 expects `## Idea N:` heading format from Claude.

**Fix approach (determine from actual output):**

- If Claude's output is raw markdown text (not JSON), the `jq` calls on both paths will fail. Add a third path that handles raw text output directly — read the file as-is and parse the markdown.
- If Claude returns JSON, fix the jq paths to match the actual structure.
- Ensure the AWK file-writing logic (lines 446-462) matches the heading format Claude actually uses in its response. Check the ideas prompt (`~/model-citizen-vault/.enrichment/prompts/ideas.md`) for what format it requests.
- Per CONTEXT.md, prompt structure is within Claude's discretion — adjust either the prompt's requested output format OR the parsing logic to align.

**Each idea file must contain:**
- Frontmatter: source, created (date), status: idea
- Body: Source backlink, title, outline bullets, supporting sources, rationale, vault connections
  </action>
  <verify>
After full pipeline run:
```bash
ls ~/model-citizen-vault/ideas/n8n-enrichment-test-idea-*.md
# Should show 2-3 files
cat ~/model-citizen-vault/ideas/n8n-enrichment-test-idea-1.md
# Should have frontmatter and body content
```
  </verify>
  <done>
Idea card files (2-3) created in ideas/ directory with proper frontmatter and body content from Claude's idea generation output.
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix finalization and run end-to-end test</name>
  <files>~/model-citizen-vault/scripts/enrich-source.sh</files>
  <action>
Fix the finalization section (line 524) and run end-to-end verification.

**Bug:** Line 524 calls:
```bash
"$PYTHON" "$SCRIPTS_DIR/update-frontmatter.py" --source "$SOURCE_FILE" --field status --value "$FINAL_STATUS" --status "$FINAL_STATUS"
```

Per update-frontmatter.py's argparse (line 140), `--status` is an optional parameter that auto-adds `enriched_at` timestamp when value is "enriched". The `--field status --value enriched` sets the status field, and `--status enriched` also sets it with the timestamp bonus. This is redundant but may not error — verify by running it. If it does error, simplify to just `--field status --value "$FINAL_STATUS"` and handle the enriched_at timestamp separately, or use only `--field enriched_at --value "$(date -u +%Y-%m-%dT%H:%M:%SZ)"` as a second call.

**Also check:** The quality flags section (lines 490-496) references `$TAGGING_JSON` which was `rm -f`'d on line 388. This would cause the quality check to silently fail. Move the `rm -f "$TAGGING_JSON"` to after the quality flags section, or restructure to not depend on the temp file.

**End-to-end test:** After all fixes from Tasks 1-3:
```bash
cd ~/model-citizen-vault
# Reset test source
python3 scripts/update-frontmatter.py --source sources/test/n8n-enrichment-test.md --field status --value ingested
# Clear previous outputs
rm -f ideas/n8n-enrichment-test-idea-*.md
rm -f .model-citizen/outputs/enrich-*-n8n-enrichment-test-*.json
# Run enrichment
bash scripts/enrich-source.sh --source sources/test/n8n-enrichment-test.md --verbose
```
  </action>
  <verify>
After running the end-to-end test:
1. `grep "^tags:" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md` — non-empty array
2. `grep "^quotes:" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md` — non-empty array
3. `grep "^takeaways:" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md` — non-empty array
4. `ls ~/model-citizen-vault/ideas/n8n-enrichment-test-idea-*.md` — 2-3 files exist
5. `grep "^status:" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md` — shows "enriched"
6. `ls ~/model-citizen-vault/.enrichment/logs/.enrichment-daily-*.md` — daily log exists
  </verify>
  <done>
Status updated to "enriched", daily log created, and full end-to-end enrichment pipeline produces all expected outputs on test source.
  </done>
</task>

</tasks>

<verification>
Run full enrichment on test source and verify all outputs:
```bash
# Check frontmatter has populated fields
grep -E "^(tags|quotes|takeaways|status):" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md

# Check idea cards exist
ls -la ~/model-citizen-vault/ideas/n8n-enrichment-test-idea-*.md

# Check daily log
ls ~/model-citizen-vault/.enrichment/logs/.enrichment-daily-*.md
```

All must show non-empty, populated values.
</verification>

<success_criteria>
1. tags array has 5-10 entries (not empty [])
2. quotes array has 2-3 entries (not empty [])
3. takeaways array has 3-5 entries (not empty [])
4. ideas/ directory has 2-3 idea card files with proper frontmatter and body content
5. Source status is "enriched" (not "ingested")
6. Daily enrichment log exists with entry for this run
</success_criteria>

<output>
After completion, create `.planning/phases/07-enrichment-pipeline/07-03-SUMMARY.md`
</output>
