---
phase: 07-enrichment-pipeline
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/model-citizen-vault/scripts/enrich-source.sh
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Running enrich-source.sh on a source populates tags (5-10), quotes (2-3), and takeaways (3-5) in frontmatter"
    - "Running enrich-source.sh creates 2-3 idea card files in ideas/ directory"
    - "After enrichment completes, source status is updated to 'enriched' and daily log entry is created"
  artifacts:
    - path: "~/model-citizen-vault/sources/test/n8n-enrichment-test.md"
      provides: "Frontmatter with populated tags, quotes, takeaways arrays"
      contains: "status: enriched"
    - path: "~/model-citizen-vault/ideas/"
      provides: "2-3 idea card files generated from test source"
  key_links:
    - from: "enrich-source.sh tagging extraction"
      to: "source frontmatter tags/quotes/takeaways"
      via: "update-frontmatter.py --json-file"
      pattern: "tags.*\\[.*\\]"
    - from: "enrich-source.sh idea generation"
      to: "ideas/ directory"
      via: "file creation from Claude output (lines 397-466)"
    - from: "enrich-source.sh finalization"
      to: "source status field"
      via: "update-frontmatter.py --field status --value enriched"
---

<objective>
Fix three enrichment pipeline bugs: tagging extraction produces empty arrays, idea card files are never created, and quality flags reference a deleted temp file.

Purpose: Phase 7 verification found only 1/4 enrichment types working (summaries). This closes the remaining gaps so the full pipeline delivers tags, quotes, takeaways, idea cards, and status updates.

Output: Working enrich-source.sh that produces complete enrichment output on test source.
</objective>

<execution_context>
@/Users/adial/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adial/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/07-enrichment-pipeline/07-01-SUMMARY.md
@.planning/phases/07-enrichment-pipeline/07-VERIFICATION.md
@~/model-citizen-vault/scripts/enrich-source.sh
@~/model-citizen-vault/scripts/update-frontmatter.py
@~/model-citizen-vault/scripts/claude-task-runner.sh
@~/model-citizen-vault/.enrichment/prompts/tagging.md
@~/model-citizen-vault/.enrichment/prompts/ideas.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix tagging extraction and idea card creation, move temp file cleanup</name>
  <files>~/model-citizen-vault/scripts/enrich-source.sh</files>
  <action>
Fix three bugs in enrich-source.sh. All three touch the same file and are interdependent (the temp file fix affects both parsing and quality checks), so they are combined into one task.

**Bug A — Tagging extraction (lines 334-391) produces empty arrays:**

The AWK parser (lines 351-373) expects exactly `^  - ` (two-space indent) after YAML headers. Claude's output may use different formats. Fix by making the parser robust to ALL likely formats:

1. Replace the three AWK blocks (lines 351-373) with a single unified parser that handles multiple formats:
   - Two-space indent: `  - item` (current expectation)
   - No indent: `- item` (common Claude output)
   - Four-space indent: `    - item`
   - Quoted items: `  - "item"` (strip surrounding quotes)

2. Change the AWK pattern on lines 356, 364, 372 from `/^  - /` to `/^[[:space:]]*- /` so it matches any indentation level.

3. Also update the `sub()` call from `sub(/^  - /, "")` to `sub(/^[[:space:]]*- /, "")` to strip whatever indentation was matched.

4. Additionally, add a JSON detection fallback BEFORE the AWK parsing: if the raw content (after stripping code fences) starts with `{`, try `jq` first. The existing check on line 341 only works if the file is valid JSON at the top level, but Claude sometimes wraps JSON in markdown prose. Add:
   ```bash
   # Try to extract JSON from within the content
   JSON_BLOCK=$(echo "$TAGGING_CONTENT" | sed -n '/^{/,/^}/p' | head -50)
   if echo "$JSON_BLOCK" | jq -e '.tags' > /dev/null 2>&1; then
       echo "$JSON_BLOCK" | jq '{tags, quotes, takeaways}' > "$TAGGING_JSON"
   else
       # Fall through to AWK parsing with relaxed indentation
       ...existing AWK logic with the fix above...
   fi
   ```

5. After creating `$TAGGING_JSON`, validate it is non-empty JSON before calling update-frontmatter.py. If empty/invalid, log a warning but don't fail the pipeline.

**Bug B — Idea card files never created (lines 397-466):**

Both paths assume structured output that Claude doesn't produce. Fix by adding a raw-text fallback path:

1. After the existing `jq -e '.generated_ideas'` check (line 401) and the `jq -r '.ideas // ...'` fallback (line 443), add a third path that handles raw markdown text directly:
   ```bash
   else
       # Raw text fallback — read file content directly (not via jq)
       IDEAS_RAW=$(cat "$IDEAS_OUTPUT_FILE")
       # Strip code fences
       IDEAS_CONTENT=$(echo "$IDEAS_RAW" | sed '1{/^```/d;}; ${/^```/d;}')
   ```

2. Relax the AWK heading pattern on line 447 from `/^## Idea [0-9]+:/` to `/^##? ?[Ii]dea[[:space:]]*[0-9]*[:.]/` to match variations like `# Idea 1:`, `## Idea 1.`, `## idea 1:`, etc.

3. If the AWK parser produces zero files (IDEA_COUNT=0 after line 464), add a final fallback that splits the raw content by any `## ` heading and writes each section as an idea card. This ensures at least something is produced even if Claude's exact heading format doesn't match.

**Bug C — Quality flags reference deleted temp file (lines 489-496):**

Line 388 runs `rm -f "$TAGGING_JSON"` but lines 491 and 499 reference `$TAGGING_JSON`. Fix: Move the `rm -f "$TAGGING_JSON"` from line 388 to AFTER the quality flags section (after line 496). Specifically, place it after line 499 (the quote count check) since that's the last reference to `$TAGGING_JSON`. Add a comment: `# Clean up temp file after quality checks are done`.
  </action>
  <verify>
Verify the code changes are syntactically correct:
```bash
bash -n ~/model-citizen-vault/scripts/enrich-source.sh
```
Confirm:
- AWK patterns use `[[:space:]]*- ` instead of `^  - `
- `rm -f "$TAGGING_JSON"` appears AFTER line 499 (quality flags section), not on line 388
- A raw-text fallback path exists in the idea card section
  </verify>
  <done>
All three bugs fixed in enrich-source.sh: (A) tagging parser handles flexible indentation and embedded JSON, (B) idea cards have raw-text fallback path, (C) temp file cleanup moved after quality flags.
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end pipeline test on test source</name>
  <files>~/model-citizen-vault/scripts/enrich-source.sh</files>
  <action>
Run the full enrichment pipeline on the test source to verify all fixes from Task 1 work together.

**Setup:**
```bash
cd ~/model-citizen-vault
# Reset test source status
python3 scripts/update-frontmatter.py --source sources/test/n8n-enrichment-test.md --field status --value ingested
# Clear previous idea card outputs
rm -f ideas/n8n-enrichment-test-idea-*.md
# Clear previous enrichment outputs
rm -f .model-citizen/outputs/enrich-*-n8n-enrichment-test-*.json
```

**Run:**
```bash
bash scripts/enrich-source.sh --source sources/test/n8n-enrichment-test.md --verbose
```

**Verify all 6 success criteria (see success_criteria section). If any fail:**

1. If tags/quotes/takeaways are empty: Check the actual output file format in `.model-citizen/outputs/enrich-tagging-*.json`, compare against the AWK parser patterns, and fix the mismatch. The fix should adjust the parser (not the prompt) since the prompt output format is unpredictable.

2. If idea cards don't exist: Check `.model-citizen/outputs/enrich-ideas-*.json` content, compare against the heading patterns in the AWK parser, and fix the mismatch. Same principle — fix the parser to match what Claude produced.

3. If status is not "enriched": Check the pipeline log output for errors in the finalization section. The `--field status --value enriched` call should work; if `--status enriched` causes a duplicate argument error, remove the `--status` flag.

**Iterate until all 6 criteria pass.** This is a test-and-fix task — the executor should make additional small fixes as needed based on actual pipeline output.
  </action>
  <verify>
All 6 checks must pass:
```bash
grep "^tags:" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md  # non-empty array
grep "^quotes:" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md  # non-empty array
grep "^takeaways:" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md  # non-empty array
ls ~/model-citizen-vault/ideas/n8n-enrichment-test-idea-*.md  # 2-3 files
grep "^status:" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md  # shows "enriched"
ls ~/model-citizen-vault/.enrichment/logs/.enrichment-daily-*.md  # log exists
```
  </verify>
  <done>
Full enrichment pipeline produces all expected outputs: tags (5-10), quotes (2-3), takeaways (3-5), idea cards (2-3 files), status "enriched", and daily log entry.
  </done>
</task>

</tasks>

<verification>
Run full enrichment on test source and verify all outputs:
```bash
# Check frontmatter has populated fields
grep -E "^(tags|quotes|takeaways|status):" ~/model-citizen-vault/sources/test/n8n-enrichment-test.md

# Check idea cards exist
ls -la ~/model-citizen-vault/ideas/n8n-enrichment-test-idea-*.md

# Check daily log
ls ~/model-citizen-vault/.enrichment/logs/.enrichment-daily-*.md
```

All must show non-empty, populated values.
</verification>

<success_criteria>
1. tags array has 5-10 entries (not empty [])
2. quotes array has 2-3 entries (not empty [])
3. takeaways array has 3-5 entries (not empty [])
4. ideas/ directory has 2-3 idea card files with proper frontmatter and body content
5. Source status is "enriched" (not "ingested")
6. Daily enrichment log exists with entry for this run
</success_criteria>

<output>
After completion, create `.planning/phases/07-enrichment-pipeline/07-03-SUMMARY.md`
</output>
