---
phase: 07-enrichment-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/model-citizen-vault/.enrichment/prompts/summarize.md
  - ~/model-citizen-vault/.enrichment/prompts/tagging.md
  - ~/model-citizen-vault/.enrichment/prompts/ideas.md
  - ~/model-citizen-vault/.enrichment/prompts/draft.md
  - ~/model-citizen-vault/scripts/enrich-source.sh
  - ~/model-citizen-vault/scripts/update-frontmatter.py
  - ~/model-citizen-vault/.enrichment/quality/generic-patterns.txt
autonomous: true

must_haves:
  truths:
    - "Claude Code can summarize a source and produce 2-3 sentence summary"
    - "Claude Code can extract tags, quotes, and takeaways from a source"
    - "Claude Code can generate 2-3 blog idea cards with vault-aware synthesis"
    - "Enrichment metadata persists in source frontmatter after processing"
    - "Generic language in summaries gets flagged with needs_review"
  artifacts:
    - path: "~/model-citizen-vault/.enrichment/prompts/summarize.md"
      provides: "Summarization prompt template"
    - path: "~/model-citizen-vault/.enrichment/prompts/tagging.md"
      provides: "Tagging and metadata extraction prompt"
    - path: "~/model-citizen-vault/.enrichment/prompts/ideas.md"
      provides: "Idea card generation prompt with vault search"
    - path: "~/model-citizen-vault/scripts/enrich-source.sh"
      provides: "Orchestration script: summary -> parallel tag+ideas -> update frontmatter"
      min_lines: 100
    - path: "~/model-citizen-vault/scripts/update-frontmatter.py"
      provides: "Python script to update YAML frontmatter atomically"
  key_links:
    - from: "scripts/enrich-source.sh"
      to: "scripts/claude-task-runner.sh"
      via: "invokes wrapper for each enrichment task"
      pattern: "claude-task-runner\\.sh"
    - from: "scripts/enrich-source.sh"
      to: "scripts/update-frontmatter.py"
      via: "calls python to merge enrichment output into source frontmatter"
      pattern: "update-frontmatter\\.py"
    - from: "scripts/enrich-source.sh"
      to: ".enrichment/prompts/"
      via: "reads prompt templates to construct task files"
      pattern: "prompts/"
---

<objective>
Create the enrichment pipeline scripts and prompt templates that transform raw ingested sources into summarized, tagged, idea-rich content.

Purpose: This is the core value of Model Citizen -- turning YouTube transcripts into blog-ready idea material with structured metadata.
Output: Prompt templates for 4 enrichment tasks, orchestration script, frontmatter update utility, and quality flag detection.
</objective>

<execution_context>
@/Users/adial/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adial/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-claude-code-integration/06-01-SUMMARY.md
@.planning/phases/06-claude-code-integration/06-02-SUMMARY.md
@.planning/phases/07-enrichment-pipeline/07-RESEARCH.md
@.planning/phases/07-enrichment-pipeline/07-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prompt templates and frontmatter utility</name>
  <files>
    ~/model-citizen-vault/.enrichment/prompts/summarize.md
    ~/model-citizen-vault/.enrichment/prompts/tagging.md
    ~/model-citizen-vault/.enrichment/prompts/ideas.md
    ~/model-citizen-vault/.enrichment/prompts/draft.md
    ~/model-citizen-vault/.enrichment/quality/generic-patterns.txt
    ~/model-citizen-vault/scripts/update-frontmatter.py
  </files>
  <action>
    Create `.enrichment/prompts/` directory and `.enrichment/quality/` directory.

    **Prompt templates** (each is a markdown file that gets injected into task files):

    1. `summarize.md`: Instruct Claude to produce 2-3 sentence summary capturing main argument, novel insights, and practical takeaways. Use XML tags for transcript content (`<transcript>` placeholder). Output plain text only, no preamble.

    2. `tagging.md`: Takes `<summary>` and `<transcript>` XML tags. Extracts:
       - 5-10 specific topic tags (avoid generic: "technology", "interesting"). Use concrete domains like "prompt-engineering", "knowledge-management".
       - 2-3 key quotes with timestamps: `[HH:MM:SS] "exact quote"`
       - 3-5 actionable takeaways
       - Output as raw YAML (no code fences): `tags:`, `quotes:`, `takeaways:` fields.

    3. `ideas.md`: Takes `<summary>`, `<source_file>`, and `<related_vault_notes>` XML tags. Generates 2-3 blog angles, each with:
       - Title, outline (3-5 bullets), supporting source quotes with timestamps
       - Rationale: unique perspective, shareability, gap it fills
       - Vault connections: related notes to synthesize with (Obsidian `[[wikilink]]` format)
       - Prioritize practical application, cross-domain insights, context-appropriate angles
       - Output as markdown with `## Idea N: [Title]` headers.

    4. `draft.md`: Takes `<summary>`, `<idea>`, and `<source_file>` XML tags. Creates first draft outline with intro hook, main sections, conclusion, and citations/backlinks to source. This is for manual trigger only.

    **Quality patterns file** (`generic-patterns.txt`): One pattern per line -- words/phrases that indicate generic/vague summaries: "interesting", "explores", "discusses", "in this video", "talks about", "covers", "deep dive", "comprehensive", "robust", "holistic".

    **Frontmatter update script** (`update-frontmatter.py`):
    - Install python-frontmatter: `pip install python-frontmatter` (or check if available)
    - Accept arguments: `--source <path>` `--field <key>` `--value <json-or-string>` `--status <status>`
    - Can also accept `--json-file <path>` to merge all fields from a JSON file into frontmatter
    - Uses atomic write pattern (temp + rename)
    - Handles: adding `summary`, `tags`, `quotes`, `takeaways`, `status`, `enriched_at`, `needs_review` fields
    - If `--status enriched` is passed, also set `enriched_at` to current ISO timestamp
    - Validate that source file exists and has valid frontmatter before modifying
  </action>
  <verify>
    - All 4 prompt files exist in `~/model-citizen-vault/.enrichment/prompts/`
    - `generic-patterns.txt` exists with 10+ patterns
    - `update-frontmatter.py` is executable and runs without import errors: `python3 ~/model-citizen-vault/scripts/update-frontmatter.py --help`
    - Test frontmatter update on a sample file: create temp markdown with frontmatter, run update, verify field added
  </verify>
  <done>
    4 prompt templates ready for task file construction, frontmatter utility working with atomic writes, quality patterns file populated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create enrichment orchestration script</name>
  <files>
    ~/model-citizen-vault/scripts/enrich-source.sh
  </files>
  <action>
    Create `enrich-source.sh` -- the main enrichment orchestrator that processes a single source file through the full pipeline.

    **Arguments:**
    - `--source <path>`: Path to source markdown file in vault
    - `--skip-ideas`: Skip idea generation (for quick enrichment)
    - `--draft`: Also generate draft scaffold (manual trigger only)
    - `--verbose`: Enable debug output
    - `--help`: Usage info

    **Flow (per user decision: hybrid orchestration):**

    1. **Pre-check**: Read source frontmatter. If `status: enriched`, exit 0 with message "Already enriched, skipping." (idempotency per user decision).

    2. **Step 1 - Summarization** (sequential, runs first):
       - Read `summarize.md` prompt template
       - Read source file content
       - Construct task file in `.model-citizen/tasks/` with unique ID: `enrich-summarize-{source-basename}-{timestamp}`
       - Set `output_path` to `.model-citizen/outputs/{task_id}.json`
       - Invoke `claude-task-runner.sh --task-file <path>`
       - Parse output JSON for `summary` field
       - Update source frontmatter with summary using `update-frontmatter.py`

    3. **Step 2 - Tagging + Idea Generation** (parallel per user decision):
       - **Tagging task**: Read `tagging.md` template, inject summary + transcript, create task file, invoke wrapper
       - **Idea generation task**: Read `ideas.md` template, inject summary + source path. For vault-aware synthesis: use `grep -rl` on vault `enriched/` and `ideas/` folders with keywords from summary to find related notes (simple keyword search per research recommendation). Inject top 3-5 related note paths/snippets into `<related_vault_notes>`. Create task file, invoke wrapper.
       - Run both tasks in background (`&`), wait for both (`wait`)
       - Parse tagging output: extract tags, quotes, takeaways
       - Update source frontmatter with tags, quotes, takeaways using `update-frontmatter.py --json-file`

    4. **Step 3 - Idea card creation**:
       - Parse idea generation output (markdown with `## Idea N` headers)
       - Create individual idea card files in `ideas/` folder, named: `{source-basename}-idea-{N}.md`
       - Each idea card gets frontmatter: `source`, `created`, `status: idea`, `tags` (subset from source tags)
       - Include backlink to source: `Source: [[sources/{source-basename}]]`

    5. **Step 4 - Quality flags** (per user decision: light validation):
       - Read summary from frontmatter
       - Check against `generic-patterns.txt` (case-insensitive grep)
       - Check tag count (flag if < 5)
       - Check if quotes array is empty
       - If any flag triggers: set `needs_review: true` in frontmatter

    6. **Step 5 - Finalize**:
       - Set `status: enriched` in frontmatter (triggers `enriched_at` timestamp)
       - Log to `.enrichment/logs/.enrichment-daily-YYYY-MM-DD.md`: append line with timestamp, source name, tasks completed, any flags

    7. **Optional Step 6 - Draft** (only if `--draft` flag):
       - Read `draft.md` template, inject summary + first idea card + source path
       - Create task file, invoke wrapper
       - Save output to `drafts/{source-basename}-draft.md` with frontmatter

    **Error handling** (per user decision):
    - If any enrichment task fails: retry once automatically
    - If still fails after retry: log error, skip that task, continue with remaining tasks
    - Partial enrichment is acceptable -- set `status: partial` instead of `enriched` if any task failed
    - Exit code 0 if fully enriched, 1 if partial, 2 if all tasks failed

    **Important implementation notes:**
    - Use full paths for commands (same as claude-task-runner.sh): `/opt/homebrew/bin/gtimeout`, `/Users/adial/.local/bin/claude`
    - Task files follow the YAML frontmatter schema from `.model-citizen/SCHEMA.md`
    - The prompt content goes in the task file body (below frontmatter), constructed by injecting source content into prompt template placeholders
    - Vault path: `~/model-citizen-vault`
  </action>
  <verify>
    - Script is executable: `chmod +x ~/model-citizen-vault/scripts/enrich-source.sh`
    - `--help` flag works
    - Script can detect already-enriched sources (create test file with `status: enriched`, run script, confirm skip)
    - Dry run structure check: Verify script references all prompt templates, claude-task-runner.sh, and update-frontmatter.py
  </verify>
  <done>
    Enrichment orchestration script handles full pipeline: pre-check -> summarize -> parallel tag+ideas -> quality flags -> finalize -> optional draft. Retry logic and partial enrichment supported. Idempotent via status check.
  </done>
</task>

<task type="auto">
  <name>Task 3: End-to-end test with sample source</name>
  <files>
    ~/model-citizen-vault/sources/test/enrichment-test-source.md
  </files>
  <action>
    Create a test source file and run the full enrichment pipeline to validate everything works.

    1. **Create test source** at `sources/test/enrichment-test-source.md`:
       - Frontmatter: `title`, `source_url` (fake YouTube URL), `ingested_at`, `status: ingested`, `source_type: youtube`
       - Body: 500-800 words of sample transcript content about a topic (e.g., knowledge management workflows, second brain methodology). Make it substantive enough for Claude to generate real summaries and ideas.

    2. **Run enrichment**: `~/model-citizen-vault/scripts/enrich-source.sh --source ~/model-citizen-vault/sources/test/enrichment-test-source.md --verbose`

    3. **Verify outputs**:
       - Source file now has: `summary` (2-3 sentences), `tags` (5-10), `quotes` (2-3), `takeaways` (3-5), `status: enriched`, `enriched_at`
       - Idea cards exist in `ideas/` folder (2-3 files matching `enrichment-test-source-idea-*.md`)
       - Each idea card has frontmatter with `source`, `created`, `status: idea`
       - Daily log entry exists in `.enrichment/logs/`

    4. **Test idempotency**: Re-run same command, verify it skips with "Already enriched" message.

    5. **Test quality flags**: If summary happens to contain generic language, verify `needs_review: true` is set. If not, manually test the flag mechanism by temporarily modifying the summary.

    If Claude Code authentication is not set up for SSH (setup-token not run), run the enrichment locally instead of via SSH. The script should work both ways -- locally and via SSH invocation.
  </action>
  <verify>
    - `grep "status: enriched" ~/model-citizen-vault/sources/test/enrichment-test-source.md` returns match
    - `ls ~/model-citizen-vault/ideas/enrichment-test-source-idea-*.md` returns 2-3 files
    - `ls ~/model-citizen-vault/.enrichment/logs/.enrichment-daily-*.md` returns today's log
    - Re-run exits 0 with skip message (idempotency)
  </verify>
  <done>
    Full enrichment pipeline tested end-to-end: source summarized, tagged, ideas generated, quality checked, status updated, daily log written. Idempotency confirmed.
  </done>
</task>

</tasks>

<verification>
- All prompt templates exist and contain XML placeholder tags
- update-frontmatter.py handles atomic writes and field merging
- enrich-source.sh orchestrates full pipeline with retry and partial enrichment support
- End-to-end test produces enriched source + idea cards + daily log
- Idempotency prevents re-processing enriched sources
- Quality flags detect generic language patterns
</verification>

<success_criteria>
1. A source file can go from `status: ingested` to `status: enriched` with summary, tags, quotes, takeaways in frontmatter
2. 2-3 idea card files are created in `ideas/` with vault-aware connections
3. Generic language detection flags low-quality summaries with `needs_review: true`
4. Re-running enrichment on same source is a no-op (idempotent)
5. Daily enrichment log tracks what was processed
</success_criteria>

<output>
After completion, create `.planning/phases/07-enrichment-pipeline/07-01-SUMMARY.md`
</output>
