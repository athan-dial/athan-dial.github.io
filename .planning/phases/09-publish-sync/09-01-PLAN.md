---
phase: 09-publish-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/publish-sync.sh
  - ~/.model-citizen/published-list.txt
autonomous: true

must_haves:
  truths:
    - "Running publish-sync.sh copies approved notes from vault publish_queue/ to Quartz content/"
    - "Re-running publish-sync.sh does not duplicate already-published notes"
    - "Assets referenced in notes are copied to Quartz static/ directory"
    - "Frontmatter is cleaned (status field removed, date fields mapped)"
    - "Script commits and pushes changes to Quartz repo, triggering GitHub Pages deploy"
  artifacts:
    - path: "~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/publish-sync.sh"
      provides: "Main publish sync script"
      min_lines: 80
    - path: "~/.model-citizen/published-list.txt"
      provides: "Tracking file for idempotent sync"
  key_links:
    - from: "publish-sync.sh"
      to: "model-citizen-vault/publish_queue/"
      via: "find approved notes"
      pattern: "publish_queue"
    - from: "publish-sync.sh"
      to: "model-citizen-quartz/content/"
      via: "copy transformed content"
      pattern: "content/"
---

<objective>
Build the publish-sync.sh script that copies approved notes from the vault's publish_queue/ folder to the Quartz repo's content/ directory, handling frontmatter cleanup, asset copying, idempotent tracking, and git push to trigger deployment.

Purpose: This is the final pipeline step — approved content becomes publicly visible on athan-dial.github.io/model-citizen/
Output: Working publish-sync.sh script with idempotent sync, asset handling, and Quartz deploy trigger
</objective>

<execution_context>
@/Users/adial/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adial/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/ingest-youtube.sh
@~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/enrich-source.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create publish-sync.sh script</name>
  <files>~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/publish-sync.sh</files>
  <action>
Create a bash script following the same patterns as ingest-youtube.sh and enrich-source.sh (set -euo pipefail, color output, VAULT_ROOT variable pattern).

**Key paths:**
- VAULT_ROOT: `$HOME/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault`
- QUARTZ_ROOT: `$HOME/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-quartz`
- PUBLISH_QUEUE: `$VAULT_ROOT/publish_queue`
- QUARTZ_CONTENT: `$QUARTZ_ROOT/content`
- TRACKING_FILE: `$HOME/.model-citizen/published-list.txt`
- LOCK_FILE: `$HOME/.model-citizen/sync.lock`

**Script flow:**
1. Acquire lock file (fail if already running)
2. Find approved notes using DUAL approval (per context decision):
   a. Find all .md files in publish_queue/ directory
   b. Scan vault folders (drafts/, ideas/, sources/) for .md files with `status: publish` in frontmatter (grep for `^status: publish` in first 20 lines)
   c. Merge results (deduplicate by filename)
3. For each approved file:
   a. Calculate content hash (shasum of file content)
   b. Check tracking file — if same hash exists, skip (log "unchanged")
   c. Read frontmatter and clean it:
      - Remove `status:` field (internal workflow field)
      - Map `created:` → `date:` if present
      - Map `modified:` → `lastmod:` if present
      - Add `draft: false`
      - Keep all other fields (title, tags, sources, etc.)
   d. Use python3 for frontmatter manipulation (already available, used by update-frontmatter.py in scripts/)
   e. Copy transformed content to QUARTZ_CONTENT/ (use filename as-is since Quartz handles slugs)
   f. Scan content for image references: `![[image.ext]]` and `![alt](path/image.ext)`
   g. For each image found, copy from VAULT_ROOT/media/ to QUARTZ_ROOT/static/ if it exists (log warning if missing)
   h. Update tracking file with: filename,hash,date
4. If any files were synced:
   a. cd to QUARTZ_ROOT
   b. git add content/ static/
   c. git commit -m "publish: sync N notes from vault"
   d. git push origin v4
5. Release lock file (in trap for cleanup on error too)
6. Print summary: N new, N updated, N skipped

**CRITICAL simplification per planning context:** Quartz v4 natively supports [[wikilinks]] AND Obsidian-style image embeds (`![[image.png]]`), so do NOT rewrite any links or image references. Only handle:
- Frontmatter cleanup (via transform-frontmatter.py)
- Asset copying: scan content for `![[*.png]]`, `![[*.jpg]]`, etc. and copy matching files from VAULT_ROOT/media/ to QUARTZ_ROOT/static/
- No link or path rewriting needed — Quartz handles all Obsidian syntax natively

**Flags:**
- `--dry-run`: Show what would happen without making changes
- `--verbose`: Show detailed per-file output
- No flags: normal operation with summary output

**Error handling:**
- Lock file prevents concurrent runs (trap ensures cleanup)
- Missing assets: log warning, continue
- Git push failure: log error but don't fail (user can push manually)
- Empty publish_queue: exit 0 with "nothing to publish" message
  </action>
  <verify>
Test the script structure:
1. `bash -n ~/Library/Mobile\ Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/publish-sync.sh` (syntax check)
2. Run with `--dry-run` flag to verify it finds files (or reports empty queue)
3. Verify lock file mechanism works (script creates and removes lock)
4. Asset copying test: Create a test note in publish_queue/ with `![[test-image.png]]`, create a dummy test-image.png in media/, run --dry-run, verify script reports finding the asset. Then run real mode and verify image is copied to Quartz static/ directory.
5. Missing asset test: Create a test note referencing `![[nonexistent.png]]`, run script, verify warning is logged but script continues without error.
  </verify>
  <done>
publish-sync.sh exists, passes syntax check, handles --dry-run mode, creates/removes lock files, and correctly identifies files in publish_queue/ for syncing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create frontmatter transformation helper</name>
  <files>~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/transform-frontmatter.py</files>
  <action>
Create a small Python helper script (consistent with existing update-frontmatter.py) that:

1. Reads a markdown file from stdin or file argument
2. Parses YAML frontmatter (between --- delimiters)
3. Applies transformations:
   - Remove `status` field
   - Remove `idea_score` field
   - Rename `created` → `date` (if present)
   - Rename `modified` → `lastmod` (if present)
   - Add `draft: false`
   - Preserve all other fields unchanged
4. Outputs transformed markdown to stdout

Use only Python stdlib (yaml module via `import yaml` if available, or simple string parsing since frontmatter is simple key-value YAML).

Actually — check if PyYAML is available. If not, use simple regex-based frontmatter parsing (more reliable for this use case since we're doing field-level transforms, not structural changes).

The publish-sync.sh script will call this as:
```bash
python3 "$SCRIPTS_DIR/transform-frontmatter.py" "$source_file" > "$dest_file"
```
  </action>
  <verify>
Create a test markdown file with vault-style frontmatter and pipe through the script:
```bash
echo '---
title: "Test Note"
status: publish
created: 2026-02-06
modified: 2026-02-06
tags: [test]
idea_score: 7
sources: [youtube-abc123]
---
# Content here
Some text with [[wikilink]]' | python3 ~/Library/Mobile\ Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/transform-frontmatter.py
```
Verify output has `date:` instead of `created:`, no `status:`, no `idea_score:`, has `draft: false`.
  </verify>
  <done>
transform-frontmatter.py correctly transforms vault frontmatter to Quartz-compatible frontmatter, preserving content body unchanged.
  </done>
</task>

</tasks>

<verification>
1. `bash -n publish-sync.sh` passes (no syntax errors)
2. `python3 transform-frontmatter.py` works on test input
3. `publish-sync.sh --dry-run` runs without errors (even with empty queue)
4. Lock file is created and cleaned up properly
5. Tracking file format is correct (filename,hash,date CSV)
6. Asset copying works: image in media/ is copied to Quartz static/ when referenced in a note
7. Missing asset warning logged correctly without blocking sync
</verification>

<success_criteria>
- publish-sync.sh script exists and passes syntax validation
- transform-frontmatter.py correctly maps vault → Quartz frontmatter
- Dry-run mode works without side effects
- Script follows same patterns as existing vault scripts (colors, error handling, paths)
</success_criteria>

<output>
After completion, create `.planning/phases/09-publish-sync/09-01-SUMMARY.md`
</output>
