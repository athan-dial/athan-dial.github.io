---
phase: 05-youtube-ingestion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/n8n-docker/docker-compose.yml
  - ~/n8n-docker/.env
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can start n8n Docker container with a single command"
    - "User can access n8n web interface at localhost:5678"
    - "Execute Command node is available in n8n workflow editor"
    - "Vault folder is accessible from within the container at /vault"
  artifacts:
    - path: "~/n8n-docker/docker-compose.yml"
      provides: "Docker Compose configuration for n8n"
      contains: "NODES_EXCLUDE=[]"
    - path: "~/n8n-docker/.env"
      provides: "Environment variables (optional, for future use)"
  key_links:
    - from: "docker-compose.yml"
      to: "~/model-citizen-vault"
      via: "bind mount volume"
      pattern: "model-citizen-vault:/vault"
    - from: "n8n container"
      to: "yt-dlp binary"
      via: "apk install"
      pattern: "which yt-dlp"
---

<objective>
Set up n8n Docker environment with yt-dlp and vault access

Purpose: Create the automation infrastructure for YouTube ingestion. The n8n instance will run locally via Docker with access to the model-citizen-vault filesystem and the yt-dlp tool for transcript extraction.

Output: Working n8n Docker container accessible at localhost:5678 with Execute Command node enabled, yt-dlp/ffmpeg installed, and vault mounted at /vault.
</objective>

<execution_context>
@/Users/adial/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adial/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-youtube-ingestion/05-RESEARCH.md
@.planning/phases/04-quartz-and-vault/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create n8n Docker Compose configuration</name>
  <files>~/n8n-docker/docker-compose.yml, ~/n8n-docker/.env</files>
  <action>
Create the n8n Docker directory and configuration files:

1. Create directory: `mkdir -p ~/n8n-docker`

2. Create `docker-compose.yml` with this configuration:
```yaml
version: '3.8'

services:
  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678/
      - NODES_EXCLUDE=[]
      - GENERIC_TIMEZONE=America/New_York
    volumes:
      - ~/.n8n:/home/node/.n8n
      - ~/model-citizen-vault:/vault:rw
```

3. Create `.env` file (placeholder for future env vars):
```
# n8n environment variables
# Add secrets here as needed (e.g., N8N_BASIC_AUTH_USER)
```

**Critical:** The `NODES_EXCLUDE=[]` setting enables Execute Command node (disabled by default in n8n 2.0+). The bind mount maps host vault to container path `/vault`.
  </action>
  <verify>
Files exist and contain correct configuration:
```bash
cat ~/n8n-docker/docker-compose.yml | grep -E "NODES_EXCLUDE|model-citizen-vault"
```
Should show both `NODES_EXCLUDE=[]` and the vault bind mount line.
  </verify>
  <done>docker-compose.yml exists with Execute Command enabled and vault bind mount configured</done>
</task>

<task type="auto">
  <name>Task 2: Start n8n container and install yt-dlp</name>
  <files>N/A (runtime configuration)</files>
  <action>
Start the n8n Docker container and install required tools:

1. Start n8n:
```bash
cd ~/n8n-docker && docker-compose up -d
```

2. Wait for container to be healthy (give it 10-15 seconds)

3. Install yt-dlp and ffmpeg in the container:
```bash
docker exec n8n apk add --no-cache yt-dlp ffmpeg
```

4. Verify yt-dlp is accessible:
```bash
docker exec n8n which yt-dlp
docker exec n8n yt-dlp --version
```

**Note:** yt-dlp requires ffmpeg for format conversion. The Alpine-based n8n image doesn't include these by default, so we install them manually. This installation persists as long as the container exists (but will need to be re-run if container is recreated).
  </action>
  <verify>
Container running and tools installed:
```bash
docker ps | grep n8n
docker exec n8n which yt-dlp
docker exec n8n yt-dlp --version
```
Should show container running and yt-dlp path + version.
  </verify>
  <done>n8n container running with yt-dlp and ffmpeg installed</done>
</task>

<task type="auto">
  <name>Task 3: Verify n8n web interface and vault access</name>
  <files>N/A (verification only)</files>
  <action>
Verify the n8n setup is complete:

1. Check n8n web interface is accessible:
```bash
curl -s -o /dev/null -w "%{http_code}" http://localhost:5678
```
Should return 200 (or 302 redirect to setup page on first run).

2. Verify vault is accessible from container:
```bash
docker exec n8n ls /vault
```
Should show vault folders: inbox, sources, enriched, ideas, drafts, publish_queue, published

3. Verify Execute Command node is enabled by checking if the container can run shell commands:
```bash
docker exec n8n sh -c "echo 'Execute Command works'"
```

4. Create a test file to confirm write access:
```bash
docker exec n8n sh -c "echo 'test' > /vault/inbox/test-write-access.txt"
cat ~/model-citizen-vault/inbox/test-write-access.txt
rm ~/model-citizen-vault/inbox/test-write-access.txt
```

**Expected:** All commands succeed, confirming n8n can read/write to the vault.
  </action>
  <verify>
All checks pass:
- HTTP 200/302 from localhost:5678
- Vault folders visible in container
- Write access confirmed
  </verify>
  <done>n8n web interface accessible at localhost:5678 with full vault read/write access</done>
</task>

</tasks>

<verification>
Phase infrastructure verification:

1. **Docker running:** `docker ps | grep n8n` shows container
2. **Web interface:** Open http://localhost:5678 in browser (should show n8n setup or dashboard)
3. **Execute Command enabled:** In n8n UI, add an "Execute Command" node - it should be available (not grayed out or missing)
4. **yt-dlp functional:** `docker exec n8n yt-dlp --version` returns version number
5. **Vault mounted:** `docker exec n8n ls /vault/sources` shows folder contents
</verification>

<success_criteria>
- n8n Docker container running (docker ps shows n8n)
- Web interface accessible at localhost:5678
- yt-dlp and ffmpeg installed in container
- Execute Command node available in workflow editor
- Vault mounted at /vault with read/write access from container
</success_criteria>

<output>
After completion, create `.planning/phases/05-youtube-ingestion/05-01-SUMMARY.md`
</output>
