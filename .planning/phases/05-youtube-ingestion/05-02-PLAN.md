---
phase: 05-youtube-ingestion
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - ~/.n8n/workflows/ (n8n internal workflow storage)
  - ~/model-citizen-vault/sources/youtube/ (output folder)
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User can trigger workflow with a YouTube URL and receive a normalized Markdown file"
    - "User can re-run workflow with same URL and see no duplicate created"
    - "Workflow gracefully handles invalid URLs or missing transcripts"
    - "Output files have correct frontmatter matching vault SCHEMA.md"
  artifacts:
    - path: "~/model-citizen-vault/sources/youtube/{videoId}-{slug}.md"
      provides: "Normalized YouTube source note"
      contains: "source_url:"
  key_links:
    - from: "n8n Code Node (URL parse)"
      to: "Execute Command Node (yt-dlp)"
      via: "videoId extraction"
      pattern: "videoId"
    - from: "Execute Command Node"
      to: "Write File action"
      via: "transcript + metadata"
      pattern: "transcript"
    - from: "Write File action"
      to: "/vault/sources/youtube/"
      via: "container filesystem"
      pattern: "writeFileSync.*sources/youtube"
---

<objective>
Build n8n workflow for YouTube transcript ingestion

Purpose: Create the automation workflow that accepts a YouTube URL, extracts the transcript using yt-dlp, normalizes it to Markdown with frontmatter matching the vault schema, and saves it to the sources/youtube/ folder. The workflow must be idempotent (re-running with the same URL does not create duplicates).

Output: Functional n8n workflow that produces schema-compliant Markdown files from YouTube videos.
</objective>

<execution_context>
@/Users/adial/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adial/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-youtube-ingestion/05-RESEARCH.md
@.planning/phases/05-youtube-ingestion/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create YouTube ingestion workflow in n8n</name>
  <files>~/.n8n/workflows/ (internal n8n storage)</files>
  <action>
Open n8n at http://localhost:5678 and create a new workflow named "YouTube Ingestion".

Build the workflow with these nodes in sequence:

**Node 1: Manual Trigger**
- Type: Manual Trigger
- Purpose: Allows manual execution for testing

**Node 2: Set URL**
- Type: Set
- Purpose: Accept YouTube URL as input
- Configuration: Add field `url` with test value `https://www.youtube.com/watch?v=dQw4w9WgXcQ` (use a real video for testing)

**Node 3: Parse URL (Code)**
- Type: Code
- Purpose: Extract video ID from various YouTube URL formats
- Code:
```javascript
const url = $input.first().json.url;

const patterns = [
  /(?:youtube\.com\/watch\?v=)([^&?]+)/,
  /(?:youtu\.be\/)([^?]+)/,
  /(?:youtube\.com\/embed\/)([^?]+)/,
  /(?:youtube\.com\/v\/)([^?]+)/,
  /(?:youtube\.com\/shorts\/)([^?]+)/
];

let videoId = null;
for (const pattern of patterns) {
  const match = url.match(pattern);
  if (match) {
    videoId = match[1];
    break;
  }
}

if (!videoId) {
  throw new Error(`Invalid YouTube URL: ${url}`);
}

return [{ json: { videoId, url } }];
```

**Node 4: Check Existence (Code)**
- Type: Code
- Purpose: Idempotency check - skip if file already exists
- Code:
```javascript
const fs = require('fs');
const { execSync } = require('child_process');

const videoId = $input.first().json.videoId;
const url = $input.first().json.url;
const vaultPath = '/vault/sources/youtube';

// Ensure directory exists
if (!fs.existsSync(vaultPath)) {
  fs.mkdirSync(vaultPath, { recursive: true });
}

// Check for existing files with this video ID
let existingFiles = [];
try {
  const output = execSync(`find ${vaultPath} -name "${videoId}-*.md"`, { encoding: 'utf8' });
  existingFiles = output.trim().split('\n').filter(f => f.length > 0);
} catch (error) {
  existingFiles = [];
}

if (existingFiles.length > 0) {
  return [{
    json: {
      status: 'skipped',
      reason: 'already_exists',
      videoId,
      existingFile: existingFiles[0]
    }
  }];
} else {
  return [{
    json: {
      status: 'process',
      videoId,
      url
    }
  }];
}
```

**Node 5: IF (Branch)**
- Type: IF
- Purpose: Skip processing if file exists
- Condition: `{{ $json.status }}` equals `process`
- True branch: Continue to yt-dlp
- False branch: End (or log skip)

**Node 6: Get Metadata (Execute Command)**
- Type: Execute Command
- Purpose: Fetch video metadata using yt-dlp
- Command:
```bash
yt-dlp --skip-download --print "%(id)s|||%(title)s|||%(upload_date)s" "{{ $json.url }}"
```
- Connect to True branch of IF node

**Node 7: Parse Metadata (Code)**
- Type: Code
- Purpose: Parse yt-dlp output into structured data
- Code:
```javascript
const output = $input.first().json.stdout;
const parts = output.trim().split('|||');

if (parts.length < 3) {
  throw new Error('Failed to parse video metadata');
}

const videoId = parts[0];
const title = parts[1];
const uploadDate = parts[2]; // Format: YYYYMMDD

return [{
  json: {
    videoId,
    title,
    uploadDate,
    url: $input.first().json.url || $('Set URL').item.json.url
  }
}];
```

**Node 8: Download Transcript (Execute Command)**
- Type: Execute Command
- Purpose: Download transcript VTT file
- Command:
```bash
yt-dlp --write-auto-subs --skip-download --sub-lang en --sub-format vtt --output "/vault/sources/youtube/{{ $json.videoId }}.%(ext)s" "{{ $('Set URL').item.json.url }}"
```

**Node 9: Parse VTT (Code)**
- Type: Code
- Purpose: Convert VTT to plain text
- Code:
```javascript
const fs = require('fs');

const videoId = $input.first().json.videoId;
const vttPath = `/vault/sources/youtube/${videoId}.en.vtt`;

// Check if transcript exists
if (!fs.existsSync(vttPath)) {
  // Try without language suffix
  const altPath = `/vault/sources/youtube/${videoId}.vtt`;
  if (fs.existsSync(altPath)) {
    vttPath = altPath;
  } else {
    throw new Error(`Transcript not found: ${vttPath}`);
  }
}

const vttContent = fs.readFileSync(vttPath, 'utf8');
const lines = vttContent.split('\n');
const textLines = [];

for (let i = 0; i < lines.length; i++) {
  const line = lines[i].trim();

  if (line === '' || line === 'WEBVTT' || line.includes('-->')) {
    continue;
  }
  if (/^\d+$/.test(line) || /^\d{2}:\d{2}:\d{2}/.test(line)) {
    continue;
  }
  if (line.startsWith('NOTE') || line.startsWith('STYLE') || line.startsWith('REGION')) {
    continue;
  }

  textLines.push(line);
}

const transcript = textLines.join(' ').replace(/\s+/g, ' ').trim();

// Clean up VTT file
fs.unlinkSync(vttPath);

return [{
  json: {
    ...$input.first().json,
    transcript
  }
}];
```

**Node 10: Write Markdown (Code)**
- Type: Code
- Purpose: Generate frontmatter and write final Markdown file
- Code:
```javascript
const fs = require('fs');
const path = require('path');

const { videoId, title, uploadDate, url, transcript } = $input.first().json;

// Generate slug from title
const slug = title
  .toLowerCase()
  .replace(/[^a-z0-9]+/g, '-')
  .replace(/^-|-$/g, '')
  .substring(0, 60);

// Format date as YYYY-MM-DD
const formattedDate = uploadDate.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');

// Generate frontmatter (manual YAML to avoid gray-matter dependency)
const frontmatter = [
  '---',
  `title: "${title.replace(/"/g, '\\"')}"`,
  `date: ${formattedDate}`,
  'status: "inbox"',
  'tags: []',
  'source: "YouTube"',
  `source_url: "${url}"`,
  '---',
  '',
  transcript
].join('\n');

// Write to vault
const filename = `${videoId}-${slug}.md`;
const filepath = `/vault/sources/youtube/${filename}`;

const dir = path.dirname(filepath);
if (!fs.existsSync(dir)) {
  fs.mkdirSync(dir, { recursive: true });
}

fs.writeFileSync(filepath, frontmatter, 'utf8');

return [{
  json: {
    success: true,
    filename,
    filepath,
    videoId,
    title
  }
}];
```

**Node 11: Log Result (Set or NoOp)**
- Type: Set or NoOp
- Purpose: Final output showing what happened
- Connect both the True branch final node and the False branch of IF node here

Save the workflow.
  </action>
  <verify>
Workflow exists in n8n:
- Open http://localhost:5678
- Navigate to Workflows
- "YouTube Ingestion" workflow should be visible
- Workflow should have 10-11 nodes connected
  </verify>
  <done>YouTube Ingestion workflow created with all nodes: trigger, URL input, parse, idempotency check, IF branch, yt-dlp metadata, yt-dlp transcript, VTT parse, frontmatter generation, file write</done>
</task>

<task type="auto">
  <name>Task 2: Test workflow with sample YouTube video</name>
  <files>~/model-citizen-vault/sources/youtube/*.md</files>
  <action>
Test the workflow with a real YouTube video:

1. In n8n, open the "YouTube Ingestion" workflow

2. Update the "Set URL" node with a test video URL. Use a short video with captions, for example:
   - A TED talk with clear captions
   - A tech conference talk
   - Any video you know has good auto-captions

3. Click "Execute Workflow" to run it

4. Monitor the execution:
   - Each node should show green checkmark when successful
   - If any node fails, check the error message
   - Common issues: video has no captions, video is private, network error

5. After successful execution, verify the output file:
```bash
ls ~/model-citizen-vault/sources/youtube/
cat ~/model-citizen-vault/sources/youtube/*.md | head -20
```

6. Verify frontmatter is correct:
   - Has title, date, status, tags, source, source_url fields
   - Date is in YYYY-MM-DD format
   - status is "inbox"
   - source is "YouTube"

**Expected:** Markdown file created in sources/youtube/ with video transcript and proper frontmatter.
  </action>
  <verify>
File exists and has correct structure:
```bash
ls ~/model-citizen-vault/sources/youtube/*.md
head -15 ~/model-citizen-vault/sources/youtube/*.md
```
Should show file with frontmatter containing title, date, status, tags, source, source_url.
  </verify>
  <done>Workflow successfully processes a YouTube video and creates normalized Markdown file</done>
</task>

<task type="auto">
  <name>Task 3: Verify idempotency (no duplicates on re-run)</name>
  <files>~/model-citizen-vault/sources/youtube/*.md</files>
  <action>
Test that running the workflow twice with the same URL does not create duplicates:

1. Note the current state:
```bash
ls -la ~/model-citizen-vault/sources/youtube/
```

2. In n8n, run the "YouTube Ingestion" workflow again with the SAME URL

3. Check the workflow execution:
   - The "Check Existence" node should return `status: skipped`
   - The IF node should route to the False branch
   - No yt-dlp commands should be executed

4. Verify no duplicate was created:
```bash
ls -la ~/model-citizen-vault/sources/youtube/
```
File count should be the same as before.

5. Check that the existing file was not modified:
```bash
ls -la ~/model-citizen-vault/sources/youtube/*.md
```
Timestamp should be unchanged.

**Expected:** Second run completes quickly (skipped) and no new file is created.
  </action>
  <verify>
Idempotency confirmed:
- Workflow shows "skipped" status on re-run
- No duplicate files in sources/youtube/
- Original file timestamp unchanged
  </verify>
  <done>Workflow is idempotent - re-running with same URL does not create duplicates</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Human verification of ingestion pipeline</name>
  <what-built>Complete YouTube ingestion workflow that extracts transcripts and creates vault-compliant Markdown files</what-built>
  <how-to-verify>
1. Open n8n at http://localhost:5678
2. Navigate to "YouTube Ingestion" workflow
3. Verify all nodes are connected and workflow looks complete
4. Test with YOUR chosen YouTube video:
   - Update the "Set URL" node with a video you want to ingest
   - Execute the workflow
   - Check ~/model-citizen-vault/sources/youtube/ for the output
5. Open the generated Markdown file in a text editor (or Obsidian)
6. Verify:
   - Frontmatter has correct fields (title, date, status, tags, source, source_url)
   - Body contains readable transcript text
   - File is in correct location (sources/youtube/)
7. Re-run the workflow with same URL and confirm it skips (idempotent)
  </how-to-verify>
  <resume-signal>Type "approved" if ingestion works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 05 complete verification:

1. **n8n workflow exists:** "YouTube Ingestion" workflow visible in n8n dashboard
2. **Workflow executes:** Can process a YouTube URL without errors
3. **Output correct:** Generated Markdown has correct frontmatter (matches SCHEMA.md)
4. **Idempotent:** Re-running with same URL does not create duplicate
5. **Error handling:** Invalid URLs or missing transcripts show clear error (not crash)
</verification>

<success_criteria>
MC-05: n8n Docker setup with YouTube integration - COMPLETE (Plan 01)
MC-06: Ingestion pipeline idempotent - COMPLETE (idempotency check in workflow)
MC-07: Source notes normalized to Markdown - COMPLETE (frontmatter generation matches schema)

User can:
1. Start n8n and run YouTube ingestion workflow
2. Provide YouTube URL and get normalized Markdown file
3. Find file in ~/model-citizen-vault/sources/youtube/ with correct frontmatter
4. Re-run with same URL and see no duplicate created
</success_criteria>

<output>
After completion, create `.planning/phases/05-youtube-ingestion/05-02-SUMMARY.md`
</output>
