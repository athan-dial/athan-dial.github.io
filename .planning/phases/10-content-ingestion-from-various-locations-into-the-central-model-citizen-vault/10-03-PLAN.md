---
phase: 10-content-ingestion
plan: 03
type: execute
wave: 3
depends_on: ["10-01", "10-02"]
files_modified:
  - ~/model-citizen-vault/ingest/scan.js
  - ~/model-citizen-vault/.claude/commands/scan.md
  - ~/Library/LaunchAgents/com.modelcitizen.daily-scan.plist
  - ~/model-citizen-vault/ingest/sources/youtube-align.js
autonomous: true

must_haves:
  truths:
    - "User can run a single scan command that processes queue AND pulls from Slack/Outlook"
    - "User can invoke /scan from Claude Code to trigger a full scan"
    - "Daily scan runs automatically at 9:00 AM via launchd"
    - "YouTube ingestion produces notes with same frontmatter schema as other sources"
  artifacts:
    - path: "~/model-citizen-vault/ingest/scan.js"
      provides: "Main orchestrator that runs all source scanners"
      exports: ["runScan"]
    - path: "~/model-citizen-vault/.claude/commands/scan.md"
      provides: "Claude Code slash command for /scan"
    - path: "~/Library/LaunchAgents/com.modelcitizen.daily-scan.plist"
      provides: "launchd agent for daily 9 AM scan"
  key_links:
    - from: "ingest/scan.js"
      to: "sources/web-capture.js"
      via: "processQueue call"
      pattern: "web-capture"
    - from: "ingest/scan.js"
      to: "sources/slack-scan.js"
      via: "scanSlack call"
      pattern: "scanSlack"
    - from: "ingest/scan.js"
      to: "sources/outlook-scan.js"
      via: "scanOutlook call"
      pattern: "scanOutlook"
    - from: ".claude/commands/scan.md"
      to: "ingest/scan.js"
      via: "bash execution"
      pattern: "node.*scan\\.js"
---

<objective>
Build the scan orchestrator, Claude Code slash command, launchd scheduling, and align YouTube ingestion with the new schema.

Purpose: This unifies all sources into a single invocable command, makes it available as a Claude skill (/scan), schedules daily automatic runs, and ensures YouTube notes match the new frontmatter schema.

Output: One-command scanning of all sources, /scan slash command, daily launchd job, and YouTube notes with source_type/url_hash fields.
</objective>

<execution_context>
@/Users/adial/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adial/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-content-ingestion-from-various-locations-into-the-central-model-citizen-vault/10-RESEARCH.md
@.planning/phases/10-content-ingestion-from-various-locations-into-the-central-model-citizen-vault/10-01-SUMMARY.md
@.planning/phases/10-content-ingestion-from-various-locations-into-the-central-model-citizen-vault/10-02-SUMMARY.md
@.planning/phases/05-youtube-ingestion/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scan orchestrator + YouTube alignment</name>
  <files>
    ~/model-citizen-vault/ingest/scan.js
    ~/model-citizen-vault/ingest/sources/youtube-align.js
  </files>
  <action>
    Create ingest/scan.js as the main entry point:

    runScan(options) function:
    1. Process web queue: Import web-capture.js, call process mode to handle all pending .queue/ items
    2. Scan Slack: Import slack-scan.js, call scanSlack(config). Wrap in try/catch — log error and continue if Slack credentials missing or API fails
    3. Scan Outlook: Import outlook-scan.js, call scanOutlook(config). Wrap in try/catch — same graceful degradation
    4. Log summary: "Processed X queue items, Y Slack links, Z Outlook links. N new notes created, M provenance merged."

    CLI flags:
    - node scan.js (full scan: queue + all APIs)
    - node scan.js --queue-only (just process .queue/, skip API scans)
    - node scan.js --slack-only (just Slack)
    - node scan.js --outlook-only (just Outlook)

    Create sources/youtube-align.js:
    - Utility script that reads existing YouTube notes from ~/model-citizen-vault/sources/youtube/ (Phase 5 location)
    - Adds missing frontmatter fields: url_hash (computed from YouTube URL), source_type: "youtube"
    - Does NOT move files or change folder structure — just adds frontmatter fields
    - CLI: node sources/youtube-align.js --dry-run | --apply
    - Run once to align existing notes with new schema

    scan.js should NOT run enrichment — per user decision and research recommendation, scan and enrichment are separate steps. Log reminder: "Run enrich-source.sh to enrich newly captured notes."
  </action>
  <verify>
    cd ~/model-citizen-vault/ingest && node scan.js --queue-only 2>&1 | tail -5
  </verify>
  <done>scan.js runs without error, processes queue items, attempts API scans with graceful failures when credentials missing. youtube-align.js can add url_hash and source_type to existing YouTube notes.</done>
</task>

<task type="auto">
  <name>Task 2: Claude Code slash command + launchd daily schedule + macOS Shortcut</name>
  <files>
    ~/model-citizen-vault/.claude/commands/scan.md
    ~/Library/LaunchAgents/com.modelcitizen.daily-scan.plist
  </files>
  <action>
    Create Claude Code slash command at ~/model-citizen-vault/.claude/commands/scan.md:
    ```
    Run the Model Citizen content scan. Execute:
    cd ~/model-citizen-vault/ingest && node scan.js
    Report the scan summary output to the user.
    ```
    This makes /scan available when Claude Code is opened in the model-citizen-vault directory.

    Create launchd plist at ~/Library/LaunchAgents/com.modelcitizen.daily-scan.plist:
    - Label: com.modelcitizen.daily-scan
    - ProgramArguments: [path-to-node, ~/model-citizen-vault/ingest/scan.js]
    - Find correct node path via `which node` at execution time; use /usr/local/bin/node or /opt/homebrew/bin/node (check which exists on this system)
    - StartCalendarInterval: Hour 9, Minute 0
    - StandardOutPath: /tmp/modelcitizen-scan.log
    - StandardErrorPath: /tmp/modelcitizen-scan.err
    - RunAtLoad: false
    - KeepAlive: false

    Load the launchd agent: launchctl load ~/Library/LaunchAgents/com.modelcitizen.daily-scan.plist

    Create macOS Shortcut export instructions (not the shortcut itself — that requires Shortcuts app GUI):
    Write ~/model-citizen-vault/ingest/SHARE-SHEET-SETUP.md with step-by-step instructions:
    1. Open Shortcuts app
    2. Create new shortcut named "Capture to Model Citizen"
    3. Add "Receive URLs from Share Sheet" action
    4. Add "Ask for Input" action (optional note, default empty)
    5. Add "Run Shell Script" action: node ~/model-citizen-vault/ingest/sources/web-capture.js --queue --url "[URL]" --note "[Input]"
    6. Add "Show Notification" action: "Queued for Model Citizen"
    7. Enable "Show in Share Sheet" in shortcut settings
    8. Test by sharing a URL from Safari
  </action>
  <verify>
    test -f ~/model-citizen-vault/.claude/commands/scan.md && echo "slash command exists" && launchctl list | grep modelcitizen && echo "launchd loaded" && test -f ~/model-citizen-vault/ingest/SHARE-SHEET-SETUP.md && echo "shortcut docs exist"
  </verify>
  <done>/scan Claude Code command exists. launchd agent loaded and scheduled for 9 AM daily. Share sheet setup instructions documented. User can invoke scan via Claude Code, CLI, or wait for daily auto-run.</done>
</task>

</tasks>

<verification>
1. `cd ~/model-citizen-vault/ingest && node scan.js` — runs full scan without crash
2. `launchctl list | grep modelcitizen` — shows loaded agent
3. `/scan` available in Claude Code when in vault directory
4. `node sources/youtube-align.js --dry-run` — shows what would be updated on existing YouTube notes
5. SHARE-SHEET-SETUP.md exists with clear instructions
</verification>

<success_criteria>
- Single scan.js command processes all sources (queue + Slack + Outlook)
- Graceful degradation when API credentials missing
- /scan Claude Code slash command works
- launchd runs daily at 9 AM
- YouTube notes can be aligned to new schema
- Share sheet setup documented for user to create manually
- Scan does NOT trigger enrichment (separate concern)
</success_criteria>

<output>
After completion, create `.planning/phases/10-content-ingestion-from-various-locations-into-the-central-model-citizen-vault/10-03-SUMMARY.md`
</output>
