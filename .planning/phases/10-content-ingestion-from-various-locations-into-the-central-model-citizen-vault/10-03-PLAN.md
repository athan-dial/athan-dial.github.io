---
phase: 10-content-ingestion
plan: 03
type: execute
wave: 2
depends_on: ["10-01", "10-02"]
files_modified:
  - "/Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/scan-slack.sh"
  - "/Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/scan-outlook.sh"
  - "/Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/scan-all.sh"
  - "/Users/adial/Documents/GitHub/athan-dial.github.io/.claude/commands/scan.md"
  - "/Users/adial/Library/LaunchAgents/com.model-citizen.daily-scan.plist"
autonomous: false
user_setup:
  - service: slack
    why: "Slack API access for reading saved items and DMs"
    env_vars:
      - name: SLACK_BOT_TOKEN
        source: "Slack App admin page -> OAuth & Permissions -> Bot User OAuth Token (xoxb-...)"
      - name: SLACK_BOSS_USER_ID
        source: "Slack -> Boss's profile -> More -> Copy member ID"
    dashboard_config:
      - task: "Create a Slack App with bot scopes: stars:read, im:history, im:read, users:read"
        location: "https://api.slack.com/apps -> Create New App"
  - service: microsoft-graph
    why: "Outlook email access for reading boss's emails"
    env_vars:
      - name: MS_GRAPH_CLIENT_ID
        source: "Azure AD -> App registrations -> Application (client) ID"
      - name: MS_GRAPH_TENANT_ID
        source: "Azure AD -> App registrations -> Directory (tenant) ID"
      - name: MS_GRAPH_CLIENT_SECRET
        source: "Azure AD -> App registrations -> Certificates & secrets -> New client secret"
      - name: MS_BOSS_EMAIL
        source: "Boss's email address"
    dashboard_config:
      - task: "Register app in Azure AD with Mail.Read delegated permission"
        location: "https://portal.azure.com -> Azure Active Directory -> App registrations"

must_haves:
  truths:
    - "Slack scanner pulls saved items and boss DMs with URLs, creating vault notes"
    - "Outlook scanner pulls boss emails with URLs, creating vault notes"
    - "/scan Claude command triggers all scanners on-demand"
    - "Daily launchd job runs scan automatically"
    - "URLs found in Slack/Outlook are captured with surrounding context"
  artifacts:
    - path: "/Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/scan-slack.sh"
      provides: "Slack saved items and DM scanner"
      contains: "conversations.history"
    - path: "/Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/scan-outlook.sh"
      provides: "Outlook email scanner"
      contains: "graph.microsoft.com"
    - path: "/Users/adial/Documents/GitHub/athan-dial.github.io/.claude/commands/scan.md"
      provides: "Claude Code /scan slash command"
      contains: "scan-all.sh"
    - path: "/Users/adial/Library/LaunchAgents/com.model-citizen.daily-scan.plist"
      provides: "Daily scheduled scan"
      contains: "scan-all.sh"
  key_links:
    - from: "scan-slack.sh"
      to: "capture-web.sh"
      via: "calls capture-web.sh for each extracted URL"
      pattern: "capture-web.sh"
    - from: "scan-outlook.sh"
      to: "capture-web.sh"
      via: "calls capture-web.sh for each extracted URL"
      pattern: "capture-web.sh"
    - from: "scan-all.sh"
      to: "scan-slack.sh + scan-outlook.sh"
      via: "orchestrates all scanners"
      pattern: "scan-slack.*scan-outlook"
---

<objective>
Build Slack and Outlook scanners that extract URLs and context from boss communications, create a /scan Claude command, and set up daily automated scanning via launchd.

Purpose: Automates the highest-signal content capture — materials recommended by the user's boss.
Output: Working scanners for Slack/Outlook, CLI orchestrator, Claude slash command, daily schedule.
</objective>

<execution_context>
@/Users/adial/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adial/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-content-ingestion-from-various-locations-into-the-central-model-citizen-vault/10-DESIGN.md
@.planning/phases/10-content-ingestion-from-various-locations-into-the-central-model-citizen-vault/10-RESEARCH.md
@.planning/phases/10-content-ingestion-from-various-locations-into-the-central-model-citizen-vault/10-01-SUMMARY.md
@.planning/phases/10-content-ingestion-from-various-locations-into-the-central-model-citizen-vault/10-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Slack and Outlook scanners</name>
  <files>
    /Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/scan-slack.sh
    /Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/scan-outlook.sh
    /Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/scan-all.sh
  </files>
  <action>
    **scan-slack.sh:**
    Uses Slack Web API via curl (no SDK needed):
    1. Reads SLACK_BOT_TOKEN and SLACK_BOSS_USER_ID from ~/.model-citizen/env (source it)
    2. Fetches saved items: `GET https://slack.com/api/stars.list` — extract messages with URLs
    3. Fetches DMs with boss: First `conversations.list` with types=im to find boss DM channel, then `conversations.history` on that channel
    4. For messages within last 24h (or since last scan timestamp stored in ~/.model-citizen/slack-last-scan):
       - Extract all URLs from message text (regex for http[s]://...)
       - Capture surrounding message text as context ("Boss said: ...")
       - For each URL, call capture-web.sh with --note containing the Slack context
    5. Update last-scan timestamp
    6. Log results to ~/.model-citizen/scan.log

    **scan-outlook.sh:**
    Uses Microsoft Graph API via curl:
    1. Reads MS_GRAPH_CLIENT_ID, MS_GRAPH_TENANT_ID, MS_GRAPH_CLIENT_SECRET, MS_BOSS_EMAIL from ~/.model-citizen/env
    2. Gets OAuth token: POST to `https://login.microsoftonline.com/{tenant}/oauth2/v2.0/token` with client_credentials grant
    3. Fetches recent emails from boss: `GET https://graph.microsoft.com/v1.0/me/messages?$filter=from/emailAddress/address eq '{boss_email}'&$top=50&$orderby=receivedDateTime desc`
    4. For emails within last 24h (or since ~/.model-citizen/outlook-last-scan):
       - Extract URLs from email body (HTML — use simple regex for href="http...")
       - Capture email subject + relevant body text as context
       - For each URL, call capture-web.sh with --note containing email context
    5. Update last-scan timestamp
    6. Log results

    **NOTE on MS Graph auth:** Client credentials flow requires admin consent for Mail.Read application permission. If user's org restricts this, document the alternative: device code flow with delegated permissions (interactive auth, token cached). Implement client_credentials first, add device_code fallback comment.

    **scan-all.sh:**
    Orchestrator that:
    1. Runs scan-slack.sh (continue on failure)
    2. Runs scan-outlook.sh (continue on failure)
    3. Optionally runs capture-queue.sh process (drain any queued web captures)
    4. Prints summary: X URLs from Slack, Y from Outlook, Z from queue
    5. Supports --dry-run flag (passes through to sub-scripts)

    All scripts: set -euo pipefail, color output, source ~/.model-citizen/env for credentials.
    Create ~/.model-citizen/env.example with all required variables documented.
  </action>
  <verify>
    Run `bash -n scan-slack.sh`, `bash -n scan-outlook.sh`, `bash -n scan-all.sh` for syntax validation. Verify ~/.model-citizen/env.example exists with all required variables. Test scan-all.sh --dry-run (should not fail even without credentials configured — graceful error handling).
  </verify>
  <done>Slack and Outlook scanners extract URLs and context from boss communications, calling capture-web.sh for each. scan-all.sh orchestrates both.</done>
</task>

<task type="auto">
  <name>Task 2: Create /scan Claude command and launchd daily schedule</name>
  <files>
    /Users/adial/Documents/GitHub/athan-dial.github.io/.claude/commands/scan.md
    /Users/adial/Library/LaunchAgents/com.model-citizen.daily-scan.plist
  </files>
  <action>
    **Claude Code /scan command:**
    Create .claude/commands/scan.md as a Claude Code slash command that:
    1. Runs scan-all.sh from the correct path
    2. Displays results (how many URLs captured from each source)
    3. Optionally runs enrichment on newly captured notes if user confirms

    Format as a Claude Code command prompt file:
    ```
    Run the Model Citizen content scanner to pull new content from Slack, Outlook, and the capture queue.

    Execute: `/Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/scan-all.sh`

    After scanning, report:
    - How many new URLs were captured from each source
    - Any errors or skipped items
    - List the new vault notes created

    Ask if the user wants to run enrichment on the new notes.
    ```

    **launchd plist:**
    Create com.model-citizen.daily-scan.plist that:
    1. Runs scan-all.sh daily at 7:00 AM
    2. Sets PATH to include /opt/homebrew/bin and /usr/local/bin (for node, curl)
    3. Redirects stdout/stderr to ~/.model-citizen/daily-scan.log
    4. Uses absolute path to scan-all.sh

    Include a comment at the top of scan-all.sh documenting how to load/unload the agent:
    ```
    # Install: launchctl load ~/Library/LaunchAgents/com.model-citizen.daily-scan.plist
    # Uninstall: launchctl unload ~/Library/LaunchAgents/com.model-citizen.daily-scan.plist
    # Test: launchctl start com.model-citizen.daily-scan
    ```
  </action>
  <verify>
    Verify .claude/commands/scan.md exists and is a valid command file. Verify plist is valid XML: `plutil -lint ~/Library/LaunchAgents/com.model-citizen.daily-scan.plist`. Do NOT load the agent yet (user needs to configure credentials first).
  </verify>
  <done>/scan Claude command is available for on-demand scanning. launchd plist ready to install for daily 7 AM automated scans.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete ingestion system end-to-end</name>
  <files></files>
  <action>
    Human verifies the complete ingestion system built across all 3 plans:
    1. 700 Model Citizen/ vault structure with tag-based routing (Plan 01)
    2. Web article capture tool with share sheet queue (Plan 02)
    3. Slack + Outlook scanners with /scan command and daily schedule (Plan 03)
  </action>
  <verify>
    1. Open Obsidian 2B-new vault — confirm 700 Model Citizen/ folder with 5 subfolders visible
    2. Create a test note, add #model-citizen/concept tag — confirm Auto Note Mover routes it to 700 Model Citizen/concepts/
    3. Run: `model-citizen/scripts/capture-web.sh "https://example.com"` — confirm note appears in 000 System/01 Inbox/
    4. Configure Slack credentials in ~/.model-citizen/env, then run scan-all.sh to test Slack scanner
    5. (Optional) Configure Outlook credentials and test scan-outlook.sh
    6. Test /scan in Claude Code
  </verify>
  <done>Human confirms: vault structure works, tag routing works, web capture works, at least one scanner works, /scan command works.</done>
</task>

</tasks>

<verification>
- Slack scanner connects to API and extracts URLs from saved items and boss DMs
- Outlook scanner connects to Graph API and extracts URLs from boss emails
- scan-all.sh orchestrates both scanners plus queue processing
- /scan Claude command triggers scan-all.sh
- launchd plist is valid and ready to install
- All scripts handle missing credentials gracefully
</verification>

<success_criteria>
- Content from Slack and Outlook can be captured to vault inbox
- Daily scanning is automated via launchd
- /scan command provides on-demand scanning in Claude Code
- Full pipeline verified by human: capture → vault inbox → tag → route to 700/
</success_criteria>

<output>
After completion, create `.planning/phases/10-content-ingestion-from-various-locations-into-the-central-model-citizen-vault/10-03-SUMMARY.md`
</output>
