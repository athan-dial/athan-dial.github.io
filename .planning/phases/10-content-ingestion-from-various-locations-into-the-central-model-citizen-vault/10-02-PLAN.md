---
phase: 10-content-ingestion
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - "/Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/capture-web.sh"
  - "/Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/package.json"
  - "/Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/extract-article.mjs"
autonomous: true

must_haves:
  truths:
    - "Given a URL, the web capture tool extracts full article text into a markdown vault note"
    - "Captured note lands in 000 System/01 Inbox/ with source_type: article frontmatter"
    - "Original URL is preserved in frontmatter"
    - "Duplicate URLs are detected and context is merged instead of creating new note"
  artifacts:
    - path: "/Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/capture-web.sh"
      provides: "CLI entry point for web article capture"
      contains: "readability"
    - path: "/Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/extract-article.mjs"
      provides: "Node.js article extraction using @mozilla/readability"
      contains: "Readability"
  key_links:
    - from: "capture-web.sh"
      to: "extract-article.mjs"
      via: "node invocation"
      pattern: "node.*extract-article"
    - from: "capture-web.sh"
      to: "000 System/01 Inbox/"
      via: "writes markdown note to vault inbox"
      pattern: "01 Inbox"
---

<objective>
Build a web article capture tool that extracts full article text from a URL using @mozilla/readability and saves it as a markdown note in the vault inbox.

Purpose: Enables the primary ingestion gesture — capture any web article into the vault for later curation.
Output: CLI tool that accepts a URL and produces a vault note with extracted content.
</objective>

<execution_context>
@/Users/adial/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adial/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-content-ingestion-from-various-locations-into-the-central-model-citizen-vault/10-DESIGN.md
@.planning/phases/10-content-ingestion-from-various-locations-into-the-central-model-citizen-vault/10-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Node.js article extractor and bash capture wrapper</name>
  <files>
    /Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/package.json
    /Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/extract-article.mjs
    /Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/capture-web.sh
  </files>
  <action>
    **extract-article.mjs:**
    Node.js ESM script that:
    1. Takes a URL as argv[1]
    2. Fetches the page HTML using native fetch (Node 18+)
    3. Parses with @mozilla/readability + linkedom (lightweight DOM, not jsdom — faster, no native deps)
    4. Converts extracted HTML to markdown using turndown
    5. Outputs JSON to stdout: { title, byline, excerpt, content (markdown), url, siteName }

    **package.json:**
    Create in model-citizen/scripts/ with dependencies: @mozilla/readability, linkedom, turndown. Run `npm install` after creating.

    **capture-web.sh:**
    Bash wrapper that:
    1. Accepts: URL as $1, optional --note "quick note" flag
    2. Calls extract-article.mjs to get article JSON
    3. Generates filename from title (slugified, max 60 chars) + date
    4. Checks for duplicate URL in vault (grep -r "url:" across inbox and 700 Model Citizen/) — if found, append context note to existing file instead of creating new one
    5. Creates markdown note in vault inbox (`/Users/adial/Library/Mobile Documents/iCloud~md~obsidian/Documents/2B-new/000 System/01 Inbox/`) with frontmatter:
       ```
       ---
       title: "{extracted title}"
       url: "{original url}"
       source_type: article
       captured_at: "{ISO date}"
       tags: []
       site_name: "{extracted site}"
       ---

       {optional quick note if --note provided}

       ## Summary
       {excerpt}

       ## Content
       {full extracted markdown}
       ```
    6. Follows existing script patterns: set -euo pipefail, color output
    7. Prints success message with file path

    Run `npm install` in model-citizen/scripts/ after creating package.json.
  </action>
  <verify>
    Run `bash -n capture-web.sh` for syntax check. Run `node extract-article.mjs "https://example.com"` and confirm JSON output with title and content fields. Run `capture-web.sh "https://example.com"` and confirm a .md file is created in the vault inbox with correct frontmatter.
  </verify>
  <done>Web capture CLI works: given a URL, extracts article content and creates a properly formatted vault note in the inbox.</done>
</task>

<task type="auto">
  <name>Task 2: Create macOS Shortcut for share sheet capture</name>
  <files>
    /Users/adial/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/capture-queue.sh
  </files>
  <action>
    **Share sheet approach:** Create a capture queue file that macOS Shortcuts can append to, then a processing script that drains the queue.

    **capture-queue.sh:**
    Two modes:
    1. `capture-queue.sh add "URL" ["optional note"]` — appends URL + note + timestamp to queue file at `~/.model-citizen/capture-queue.txt` (one JSON line per entry: {"url":"...","note":"...","ts":"..."})
    2. `capture-queue.sh process` — reads queue file, runs capture-web.sh for each URL, clears processed entries. Handles errors gracefully (failed URLs stay in queue).

    The queue file enables async capture — Shortcuts adds to queue instantly, batch processing happens later.

    **macOS Shortcut instructions** (document in a comment block at top of capture-queue.sh):
    Create a Shortcut called "Capture to Vault" that:
    1. Accepts Share Sheet input (URLs, Safari pages)
    2. Optionally asks for a quick note (text input, "Add a note?" with default empty)
    3. Runs shell script: `/path/to/capture-queue.sh add "$URL" "$NOTE"`

    Include the exact Shortcuts steps as comments so the user can create it manually. The Shortcut itself cannot be created programmatically.
  </action>
  <verify>
    Run `bash -n capture-queue.sh`. Test: `capture-queue.sh add "https://example.com" "test note"` then verify ~/.model-citizen/capture-queue.txt has the entry. Test: `capture-queue.sh process` and verify it calls capture-web.sh and clears the queue.
  </verify>
  <done>Queue-based capture system works: URLs can be queued instantly and batch-processed later. Share sheet instructions documented.</done>
</task>

</tasks>

<verification>
- extract-article.mjs fetches and parses a real URL
- capture-web.sh creates a vault note with correct frontmatter
- capture-queue.sh add/process cycle works
- Duplicate URL detection prevents duplicate notes
</verification>

<success_criteria>
- Any web URL can be captured to vault inbox via CLI
- Queue system enables async capture from share sheet
- Articles are extracted with full text, not just URLs
</success_criteria>

<output>
After completion, create `.planning/phases/10-content-ingestion-from-various-locations-into-the-central-model-citizen-vault/10-02-SUMMARY.md`
</output>
