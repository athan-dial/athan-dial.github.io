---
phase: 10-content-ingestion
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - ~/model-citizen-vault/ingest/sources/slack-scan.js
  - ~/model-citizen-vault/ingest/sources/outlook-scan.js
  - ~/model-citizen-vault/ingest/package.json
autonomous: false
user_setup:
  - service: slack
    why: "Scan saved items and boss DMs for shared links"
    env_vars:
      - name: SLACK_BOT_TOKEN
        source: "Slack App Management → Your App → OAuth & Permissions → Bot User OAuth Token (xoxb-...)"
      - name: SLACK_BOSS_DM_ID
        source: "Run setup script (created in this plan) to discover DM channel ID"
    dashboard_config:
      - task: "Create Slack App with scopes: bookmarks:read, channels:read, im:history, im:read, users:read"
        location: "https://api.slack.com/apps → Create New App → OAuth & Permissions → Add scopes → Install to Workspace"
  - service: microsoft-graph
    why: "Scan boss's Outlook emails for shared links"
    env_vars:
      - name: MS_CLIENT_ID
        source: "Azure Portal → App registrations → Your App → Application (client) ID"
      - name: MS_TENANT_ID
        source: "Azure Portal → App registrations → Your App → Directory (tenant) ID"
      - name: MS_CLIENT_SECRET
        source: "Azure Portal → App registrations → Your App → Certificates & secrets → New client secret"
      - name: BOSS_EMAIL
        source: "Boss's work email address"
    dashboard_config:
      - task: "Register Azure AD app with Mail.Read permission (Application type, not Delegated)"
        location: "Azure Portal → App registrations → New registration → API permissions → Add permission → Microsoft Graph → Application → Mail.Read"
      - task: "Grant admin consent for Mail.Read permission"
        location: "Azure Portal → App registrations → Your App → API permissions → Grant admin consent"

must_haves:
  truths:
    - "User can scan Slack saved items and see new vault notes for each link found"
    - "User can scan boss DMs and see vault notes with surrounding context preserved"
    - "User can scan boss Outlook emails and see vault notes for each link found with email context"
    - "Scans only fetch items since last scan (incremental, not full history)"
  artifacts:
    - path: "~/model-citizen-vault/ingest/sources/slack-scan.js"
      provides: "Slack saved items and boss DM scanning"
      exports: ["scanSlack"]
    - path: "~/model-citizen-vault/ingest/sources/outlook-scan.js"
      provides: "Outlook email scanning for boss's messages with links"
      exports: ["scanOutlook"]
  key_links:
    - from: "sources/slack-scan.js"
      to: "shared/vault-writer.js"
      via: "writeToVault for each extracted link"
      pattern: "writeToVault\\("
    - from: "sources/outlook-scan.js"
      to: "shared/vault-writer.js"
      via: "writeToVault for each extracted link"
      pattern: "writeToVault\\("
    - from: "sources/slack-scan.js"
      to: "sources/web-capture.js"
      via: "extractArticle for URL content extraction"
      pattern: "extractArticle\\("
---

<objective>
Build Slack and Outlook source scanners that pull links from boss communications and create vault notes.

Purpose: These are the two workplace sources where the user receives content recommendations. Both extract URLs with surrounding context ("read this because...") and feed into the same vault pipeline.

Output: Two scanner modules (slack-scan.js, outlook-scan.js) that connect to APIs, extract links with context, and write normalized vault notes via shared infrastructure from Plan 01.
</objective>

<execution_context>
@/Users/adial/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adial/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-content-ingestion-from-various-locations-into-the-central-model-citizen-vault/10-RESEARCH.md
@.planning/phases/10-content-ingestion-from-various-locations-into-the-central-model-citizen-vault/10-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Slack scanner — saved items + boss DMs</name>
  <files>
    ~/model-citizen-vault/ingest/sources/slack-scan.js
    ~/model-citizen-vault/ingest/package.json
  </files>
  <action>
    Install @slack/web-api. Create sources/slack-scan.js:

    scanSlack(config) function:

    1. Initialize WebClient with SLACK_BOT_TOKEN from config.

    2. Scan saved items (bookmarks): Call bookmarks.list for relevant channels. Filter bookmarks with type "link". Extract title and URL from each bookmark.

    3. Scan boss DMs: Call conversations.history with channel: SLACK_BOSS_DM_ID and oldest: lastScanTimestamp (stored in ~/model-citizen-vault/ingest/.last-scan-slack). Extract URLs from message text using URL regex. For each URL found, capture surrounding message text as provenance/context (e.g., "Boss said: 'Check this out, relevant to our ML pipeline work'"). Handle rate limiting: if 429 response, wait Retry-After seconds and retry (max 3 retries).

    4. For each extracted URL: fetch article content via web-capture.js extractArticle(), then call vault-writer.writeToVault with source_type: "slack", provenance including the context message.

    5. After successful scan, write current timestamp to .last-scan-slack.

    6. Handle Slack rate limits (15 msg max per call per research): use cursor-based pagination if available, otherwise accept 15 msg limit per scan (daily scan makes this acceptable).

    Also create a one-time setup helper: node slack-scan.js --setup which calls conversations.list with types=im, displays DM channels with user names, and tells user which ID to put in .env as SLACK_BOSS_DM_ID.

    CLI: node slack-scan.js [--setup]
  </action>
  <verify>
    cd ~/model-citizen-vault/ingest && node -e "import('./sources/slack-scan.js')" && node sources/slack-scan.js --setup 2>&1 | head -5
  </verify>
  <done>slack-scan.js imports cleanly and exports scanSlack. --setup mode attempts API connection (may fail without token, but code runs). With valid SLACK_BOT_TOKEN and SLACK_BOSS_DM_ID, scanning creates vault notes with source_type: slack and context from messages.</done>
</task>

<task type="auto">
  <name>Task 2: Outlook scanner — boss emails with links</name>
  <files>
    ~/model-citizen-vault/ingest/sources/outlook-scan.js
    ~/model-citizen-vault/ingest/package.json
  </files>
  <action>
    Install @microsoft/microsoft-graph-client @azure/msal-node. Create sources/outlook-scan.js:

    scanOutlook(config) function:

    1. Initialize MSAL ConfidentialClientApplication with MS_CLIENT_ID, MS_TENANT_ID, MS_CLIENT_SECRET from config.

    2. Acquire token via acquireTokenByClientCredential with scope https://graph.microsoft.com/.default.

    3. Initialize Graph client with the access token.

    4. Query /me/messages filtered by: from/emailAddress/address eq BOSS_EMAIL AND receivedDateTime ge lastScanTimestamp. Select subject, bodyPreview, receivedDateTime, body. Order by receivedDateTime desc.

    5. For each email: extract URLs from body.content using URL regex (same as Slack scanner). Capture email subject + bodyPreview as provenance context (e.g., "Boss emailed: 'Subject: Must read — new approach to...'").

    6. For each URL: fetch article content via web-capture.js extractArticle(), call vault-writer.writeToVault with source_type: "email", provenance including email context.

    7. Handle token expiry: wrap Graph calls in try/catch, on 401 re-acquire token via acquireTokenSilent() and retry once.

    8. After successful scan, write current timestamp to .last-scan-outlook.

    CLI: node outlook-scan.js
  </action>
  <verify>
    cd ~/model-citizen-vault/ingest && node -e "import('./sources/outlook-scan.js')"
  </verify>
  <done>outlook-scan.js imports cleanly and exports scanOutlook. With valid MS_CLIENT_ID, MS_TENANT_ID, MS_CLIENT_SECRET, and BOSS_EMAIL, scanning creates vault notes with source_type: email and context from email subject/body.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Configure Slack and Microsoft API credentials</name>
  <files>~/model-citizen-vault/ingest/.env</files>
  <action>
    User must create API credentials for Slack and Microsoft Graph (cannot be automated):
    1. Create Slack App at https://api.slack.com/apps with scopes: bookmarks:read, channels:read, im:history, im:read, users:read
    2. Install app to workspace, copy Bot User OAuth Token
    3. Register Azure AD App at Azure Portal with Mail.Read (Application) permission
    4. Grant admin consent, create client secret
    5. Run `node sources/slack-scan.js --setup` to discover boss DM channel ID
    6. Populate .env with all credentials
  </action>
  <verify>
    cd ~/model-citizen-vault/ingest && node sources/slack-scan.js 2>&1 | tail -3 && node sources/outlook-scan.js 2>&1 | tail -3
  </verify>
  <done>Both scanners connect to APIs and produce vault notes. Type "configured" to continue or "skip" to defer.</done>
</task>

</tasks>

<verification>
1. `node -e "import('./sources/slack-scan.js')"` — imports without error
2. `node -e "import('./sources/outlook-scan.js')"` — imports without error
3. With credentials: `node sources/slack-scan.js` creates vault notes with source_type: slack
4. With credentials: `node sources/outlook-scan.js` creates vault notes with source_type: email
5. Both scanners use incremental timestamps (only fetch since last scan)
6. Both scanners extract surrounding context as provenance
</verification>

<success_criteria>
- Slack scanner extracts links from saved items and boss DMs with message context
- Outlook scanner extracts links from boss emails with subject/body context
- Both write vault notes via shared vault-writer with correct source_type
- Both use incremental scanning (timestamp-based)
- Rate limiting handled for Slack; token refresh handled for Microsoft
</success_criteria>

<output>
After completion, create `.planning/phases/10-content-ingestion-from-various-locations-into-the-central-model-citizen-vault/10-02-SUMMARY.md`
</output>
