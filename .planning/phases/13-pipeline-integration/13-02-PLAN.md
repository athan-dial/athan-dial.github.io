---
phase: 13-pipeline-integration
plan: 02
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - ~/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/scan-all.sh
  - ~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/goodlinks-query.py
  - ~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/ingest-goodlinks.sh
autonomous: true
requirements: [INTG-01, INTG-03]

must_haves:
  truths:
    - "Running scan-all.sh executes GoodLinks scanner alongside Slack, Outlook, and web capture scanners with continue-on-failure behavior"
    - "GoodLinks scanner checks for duplicates before creating notes — a URL already in the vault from another source is skipped with tag merge"
    - "New GoodLinks notes with status:inbox are passed to enrich-source.sh for Claude enrichment (summaries, tags, ideas)"
    - "Any scanner failure triggers a macOS notification with the scanner name and error"
    - "scan-all.sh prints a run summary showing counts per source and dedup skips"
  artifacts:
    - path: "~/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/scan-all.sh"
      provides: "Updated orchestrator with GoodLinks scanner section, failure notifications, run summary"
    - path: "~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/goodlinks-query.py"
      provides: "Updated with dedup check before note emission and normalized_url in frontmatter"
    - path: "~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/ingest-goodlinks.sh"
      provides: "Updated with enrichment trigger for new notes"
  key_links:
    - from: "scan-all.sh"
      to: "ingest-goodlinks.sh"
      via: "Bash subprocess call to vault scripts directory"
      pattern: "ingest-goodlinks\\.sh"
    - from: "goodlinks-query.py"
      to: "dedup-check.py"
      via: "import check_and_handle_dedup before note emission"
      pattern: "from dedup_check import"
    - from: "ingest-goodlinks.sh"
      to: "enrich-source.sh"
      via: "Loop over new notes calling enrich-source.sh --source for each"
      pattern: "enrich-source\\.sh.*--source"
---

<objective>
Wire GoodLinks into the daily automation: add it to scan-all.sh, integrate dedup checks into the scanner, trigger enrichment for new notes, add failure notifications, and validate end-to-end flow.

Purpose: INTG-01 (scan-all.sh integration) and INTG-03 (enrichment pipeline flow) complete the v1.2 milestone — saving an article in GoodLinks automatically produces an enriched vault note.

Output: Updated scan-all.sh with GoodLinks section, updated goodlinks-query.py with dedup, updated ingest-goodlinks.sh with enrichment trigger.
</objective>

<execution_context>
@/Users/adial/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adial/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-pipeline-integration/13-RESEARCH.md
@.planning/phases/13-pipeline-integration/13-CONTEXT.md
@.planning/phases/13-pipeline-integration/13-01-SUMMARY.md
@~/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/scan-all.sh
@~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/goodlinks-query.py
@~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/ingest-goodlinks.sh
@~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/enrich-source.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate dedup into goodlinks-query.py and add enrichment to ingest-goodlinks.sh</name>
  <files>~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/goodlinks-query.py, ~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/ingest-goodlinks.sh</files>
  <action>
**Update goodlinks-query.py:**

1. Import `normalize_url` from `normalize_url` (add script dir to sys.path if needed: `sys.path.insert(0, str(Path(__file__).parent))`)
2. Import `check_and_handle_dedup` from `dedup_check`
3. In the main loop, BEFORE calling `emit_note()`:
   - Get the vault sources dir (parent of output_dir, i.e., `output_dir.parent`)
   - Call `check_and_handle_dedup(link['url'], str(sources_dir), tags, 'GoodLinks', dry_run=args.dry_run)`
   - If returns True (duplicate found): skip this link, increment a `dedup_count` counter, continue to next
   - If returns False: proceed with emit_note as before
4. In `emit_note()`: add `normalized_url: {json.dumps(normalize_url(link['url']))}` to frontmatter (after source_url line)
5. Update summary print to include dedup count: "GoodLinks scan complete: {len(created)} notes created, {dedup_count} duplicates skipped"

**Update ingest-goodlinks.sh:**

1. After the Python script runs successfully (and not in dry-run mode), add an enrichment loop:
   ```bash
   if [[ -z "$DRY_RUN" ]]; then
     VAULT_SCRIPTS="$SCRIPT_DIR"
     ENRICH="$VAULT_SCRIPTS/enrich-source.sh"
     if [[ -f "$ENRICH" ]]; then
       # Find notes created in this run (status: inbox, modified in last 5 minutes)
       find "$OUTPUT_DIR" -name "*.md" -newer "$SCRIPT_DIR/goodlinks-query.py" -mmin -5 | while read -r note; do
         echo "Enriching: $(basename "$note")"
         "$ENRICH" --source "$note" --verbose || echo "Warning: enrichment failed for $(basename "$note")"
       done
     fi
   fi
   ```
   Note: Use `-mmin -5` (modified within last 5 minutes) as a proxy for "created in this run". This is simpler than parsing script output and handles the common case. If no new notes were created, the find returns nothing and the loop is a no-op.

2. Update the completion message to distinguish scan vs enrichment:
   ```bash
   echo "GoodLinks scan + enrichment complete"
   ```
  </action>
  <verify>
1. Run `ingest-goodlinks.sh --dry-run` — should report counts including dedup skips, exit 0
2. Check that goodlinks-query.py imports normalize_url and dedup_check without import errors:
   `/opt/homebrew/bin/python3.12 -c "import sys; sys.path.insert(0, '$VAULT_SCRIPTS'); from normalize_url import normalize_url; from dedup_check import check_and_handle_dedup; print('OK')"`
3. Verify normalized_url would appear in dry-run output
  </verify>
  <done>goodlinks-query.py checks for duplicates before creating notes and includes normalized_url in frontmatter; ingest-goodlinks.sh triggers enrichment for new notes</done>
</task>

<task type="auto">
  <name>Task 2: Add GoodLinks to scan-all.sh with failure notifications and run summary</name>
  <files>~/Documents/GitHub/athan-dial.github.io/model-citizen/scripts/scan-all.sh</files>
  <action>
**Update scan-all.sh** to add GoodLinks as the 4th scanner and add failure notifications:

1. **Add GoodLinks variables** to the tracking section:
   ```bash
   GOODLINKS_URLS=0
   GOODLINKS_STATUS="SKIPPED"
   ```

2. **Add GoodLinks scanner section** after the web capture queue section (section 3), as section 4:
   ```bash
   # 4. GoodLinks Scanner
   echo -e "${BLUE}▶ Running GoodLinks scanner...${NC}"
   echo ""

   GOODLINKS_DB="$HOME/Library/Group Containers/group.com.ngocluu.goodlinks/Data/data.sqlite"
   VAULT_SCRIPTS="$HOME/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts"

   if [[ ! -f "$GOODLINKS_DB" ]]; then
     echo -e "${YELLOW}⚠ GoodLinks database not found${NC}"
     echo -e "${YELLOW}  Skipping GoodLinks scan${NC}"
     GOODLINKS_STATUS="SKIPPED"
   else
     if "$VAULT_SCRIPTS/ingest-goodlinks.sh" $DRY_RUN 2>&1 | tee /tmp/scan-goodlinks.log; then
       GOODLINKS_URLS=$(grep -o '[0-9]* notes created' /tmp/scan-goodlinks.log | grep -o '[0-9]*' || echo "0")
       GOODLINKS_DEDUP=$(grep -o '[0-9]* duplicates skipped' /tmp/scan-goodlinks.log | grep -o '[0-9]*' || echo "0")
       GOODLINKS_STATUS="SUCCESS"
       echo -e "${GREEN}✓ GoodLinks scan complete${NC}"
     else
       GOODLINKS_STATUS="FAILED"
       echo -e "${RED}✗ GoodLinks scan failed${NC}"
     fi
   fi

   echo ""
   ```

3. **Add macOS notification on ANY scanner failure** — after all scanners run, before the summary:
   ```bash
   # Notify on failures
   FAILURES=""
   [[ "$SLACK_STATUS" == "FAILED" ]] && FAILURES="${FAILURES}Slack "
   [[ "$OUTLOOK_STATUS" == "FAILED" ]] && FAILURES="${FAILURES}Outlook "
   [[ "$QUEUE_STATUS" == "FAILED" ]] && FAILURES="${FAILURES}Queue "
   [[ "$GOODLINKS_STATUS" == "FAILED" ]] && FAILURES="${FAILURES}GoodLinks "

   if [[ -n "$FAILURES" ]]; then
     osascript -e "display notification \"Failed: ${FAILURES}\" with title \"Model Citizen Scanner\" sound name \"Basso\"" 2>/dev/null || true
   fi
   ```

4. **Update summary** to include GoodLinks:
   - Add GoodLinks line: `echo "GoodLinks: $(format_status "$GOODLINKS_STATUS")   (${GOODLINKS_URLS} notes, ${GOODLINKS_DEDUP:-0} dedup)"`
   - Update TOTAL_URLS calculation: `TOTAL_URLS=$((SLACK_URLS + OUTLOOK_URLS + QUEUE_URLS + GOODLINKS_URLS))`
   - Update all-failed check: include GOODLINKS_STATUS

5. **Add retry with short delay** for GoodLinks (per CONTEXT.md decision — one retry before declaring failure):
   Replace the simple if/else with:
   ```bash
   run_with_retry() {
     if "$@" 2>&1; then
       return 0
     fi
     echo -e "${YELLOW}  Retrying in 3 seconds...${NC}"
     sleep 3
     "$@" 2>&1
   }
   ```
   Use this for the GoodLinks scanner call. Apply to other scanners too for consistency.

6. **Clean up** GoodLinks temp log with the others: `rm -f /tmp/scan-goodlinks.log`
  </action>
  <verify>
1. Run `scan-all.sh --dry-run` — should show GoodLinks section in output with SUCCESS/SKIPPED status and counts in summary
2. Verify GoodLinks appears in the scan summary table
3. Verify the all-failed check includes GoodLinks
4. Check that the notification osascript line exists in the script
  </verify>
  <done>scan-all.sh runs GoodLinks scanner as 4th source with continue-on-failure, retry logic, macOS failure notifications, and a complete run summary showing per-source counts including dedup skips</done>
</task>

</tasks>

<verification>
1. `scan-all.sh --dry-run` shows all 4 scanners (Slack, Outlook, Queue, GoodLinks) in output
2. GoodLinks section checks for DB existence before running (graceful skip)
3. `goodlinks-query.py` calls dedup check before note emission
4. `ingest-goodlinks.sh` triggers enrichment for new notes (not in dry-run mode)
5. Failure notification code exists for all scanner statuses
6. Run summary includes per-source counts and dedup stats
</verification>

<success_criteria>
- Saving an article in GoodLinks and running scan-all.sh produces an enriched vault note (summary, tags, ideas) without manual intervention
- A URL already in the vault from Slack or web capture is not duplicated when later saved in GoodLinks (dedup check + tag merge)
- Scanner failures produce macOS notifications
- Run summary shows counts per source and dedup skips
</success_criteria>

<output>
After completion, create `.planning/phases/13-pipeline-integration/13-02-SUMMARY.md`
</output>
