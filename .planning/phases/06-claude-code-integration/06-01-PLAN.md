---
phase: 06-claude-code-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/model-citizen-vault/scripts/claude-task-runner.sh
  - ~/model-citizen-vault/.model-citizen/tasks/.gitkeep
  - ~/model-citizen-vault/.model-citizen/outputs/.gitkeep
  - ~/model-citizen-vault/.model-citizen/SCHEMA.md
  - ~/.ssh/n8n_docker
  - ~/.ssh/n8n_docker.pub
  - ~/.ssh/authorized_keys
autonomous: false

user_setup:
  - service: macOS Remote Login
    why: "SSH server required for n8n container to connect to host"
    dashboard_config:
      - task: "Enable Remote Login"
        location: "System Settings > General > Sharing > Remote Login (toggle ON)"

must_haves:
  truths:
    - "n8n container can SSH to macOS host without password prompt"
    - "claude-task-runner.sh executes Claude Code with task file input"
    - "Wrapper script returns exit code 0 on success, non-zero on failure"
    - "Task outputs are written atomically (no partial writes)"
    - "Re-running wrapper with same task file skips duplicate processing"
  artifacts:
    - path: "~/model-citizen-vault/scripts/claude-task-runner.sh"
      provides: "Wrapper CLI for Claude Code invocation"
      min_lines: 80
    - path: "~/.ssh/n8n_docker"
      provides: "SSH private key for n8n authentication"
    - path: "~/.ssh/n8n_docker.pub"
      provides: "SSH public key for authorized_keys"
    - path: "~/model-citizen-vault/.model-citizen/SCHEMA.md"
      provides: "Task file format documentation"
      contains: "task_id"
  key_links:
    - from: "claude-task-runner.sh"
      to: "claude -p"
      via: "timeout command invocation"
      pattern: "timeout.*claude.*-p"
    - from: "claude-task-runner.sh"
      to: ".model-citizen/outputs/"
      via: "atomic file write"
      pattern: "mv.*\\.tmp"
---

<objective>
Establish SSH infrastructure for n8n-to-host communication and create the Claude Code wrapper CLI.

Purpose: Enable n8n (running in Docker) to invoke Claude Code on the macOS host machine via SSH. This is the foundation for automated AI synthesis in the content pipeline.

Output:
- SSH key pair for passwordless authentication
- `claude-task-runner.sh` wrapper script
- Task file schema documentation
- `.model-citizen/` directory structure
</objective>

<execution_context>
@/Users/adial/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adial/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-claude-code-integration/06-CONTEXT.md
@.planning/phases/06-claude-code-integration/06-RESEARCH.md
@.planning/phases/05-youtube-ingestion/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate SSH key pair and configure authorized_keys</name>
  <files>
    ~/.ssh/n8n_docker
    ~/.ssh/n8n_docker.pub
    ~/.ssh/authorized_keys
  </files>
  <action>
Generate a dedicated SSH key pair for n8n-to-host authentication:

1. Generate ed25519 key pair (no passphrase for automation):
   ```bash
   ssh-keygen -t ed25519 -C "n8n-docker-to-host" -f ~/.ssh/n8n_docker -N ""
   ```

2. Add public key to authorized_keys:
   ```bash
   cat ~/.ssh/n8n_docker.pub >> ~/.ssh/authorized_keys
   ```

3. Ensure correct permissions:
   ```bash
   chmod 600 ~/.ssh/n8n_docker
   chmod 644 ~/.ssh/n8n_docker.pub
   chmod 600 ~/.ssh/authorized_keys
   ```

4. Display the private key path for n8n configuration (later):
   ```bash
   echo "Private key for n8n: ~/.ssh/n8n_docker"
   ```

Do NOT prompt for passphrase - automated SSH requires passwordless keys.
  </action>
  <verify>
- `ls -la ~/.ssh/n8n_docker` shows 600 permissions
- `ls -la ~/.ssh/n8n_docker.pub` shows 644 permissions
- `grep "n8n-docker-to-host" ~/.ssh/authorized_keys` shows the key is added
  </verify>
  <done>SSH key pair generated with correct permissions, public key in authorized_keys</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Enable macOS Remote Login</name>
  <action>
User must enable Remote Login on macOS to allow SSH connections.

**Steps:**
1. Open **System Settings** (Apple menu > System Settings)
2. Go to **General > Sharing**
3. Find **Remote Login** and toggle it **ON**
4. Under "Allow access for" select **All users** (or add specific user if preferred)

**Why this cannot be automated:** macOS requires GUI or admin password to enable SSH server. System Integrity Protection prevents scripted changes to sharing preferences.
  </action>
  <how-to-verify>
After enabling:
1. Open Terminal
2. Run: `ssh localhost "echo 'SSH works'"`
3. You should see "SSH works" output (you may need to accept host key first time)
  </how-to-verify>
  <resume-signal>Type "enabled" when Remote Login is turned on and verified</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Create .model-citizen directories and task schema</name>
  <files>
    ~/model-citizen-vault/.model-citizen/tasks/.gitkeep
    ~/model-citizen-vault/.model-citizen/outputs/.gitkeep
    ~/model-citizen-vault/.model-citizen/SCHEMA.md
  </files>
  <action>
Create the task processing infrastructure in the vault:

1. Create directories:
   ```bash
   mkdir -p ~/model-citizen-vault/.model-citizen/tasks
   mkdir -p ~/model-citizen-vault/.model-citizen/outputs
   ```

2. Add .gitkeep files to preserve empty directories:
   ```bash
   touch ~/model-citizen-vault/.model-citizen/tasks/.gitkeep
   touch ~/model-citizen-vault/.model-citizen/outputs/.gitkeep
   ```

3. Create SCHEMA.md documenting the task file format:

```markdown
# Task File Schema

Task files are Markdown documents with YAML frontmatter that instruct Claude Code how to process content.

## Location

- Input: `.model-citizen/tasks/{task-id}.md`
- Output: `.model-citizen/outputs/{task-id}.json`

## Required Frontmatter Fields

| Field | Type | Description |
|-------|------|-------------|
| task_id | string | Unique identifier (UUID or timestamp-hash) |
| task_type | string | One of: summarize, tag, draft, custom |
| created_at | ISO 8601 | When task was created |
| source_path | string | Path to input file (relative to vault root) |
| output_path | string | Path for output file (relative to vault root) |

## Optional Frontmatter Fields

| Field | Type | Description |
|-------|------|-------------|
| timeout | integer | Max seconds for task (default: 600) |
| idempotency_key | string | Hash of input content for duplicate detection |
| depends_on | string[] | Other task IDs that must complete first |

## Body

The body contains the task instructions for Claude Code. Write as if giving instructions to an assistant.

## Example

```yaml
---
task_id: "abc-123-def"
task_type: "summarize"
created_at: "2026-02-05T14:30:00Z"
source_path: "sources/youtube/video-transcript.md"
output_path: ".model-citizen/outputs/abc-123-def.json"
timeout: 300
---

# Task: Summarize Video Transcript

Read the transcript at `sources/youtube/video-transcript.md` and produce:
- 3-5 sentence summary
- Key themes (max 5)
- Suggested tags for vault

Output as JSON with keys: summary, themes, tags
```

## Output Format

Outputs are JSON files with standard structure:

```json
{
  "task_id": "abc-123-def",
  "task_type": "summarize",
  "completed_at": "2026-02-05T14:35:00Z",
  "result": {
    "summary": "...",
    "themes": ["...", "..."],
    "tags": ["...", "..."]
  }
}
```

## Exit Codes

| Code | Meaning |
|------|---------|
| 0 | Success - output written |
| 1 | General error |
| 2 | Invalid input (task file missing or malformed) |
| 3 | Claude Code execution failed |
| 124 | Timeout exceeded |
```

4. Commit the new directories and schema:
   ```bash
   cd ~/model-citizen-vault
   git add .model-citizen/
   git commit -m "feat(06): add task processing infrastructure

   - .model-citizen/tasks/ for input task files
   - .model-citizen/outputs/ for Claude Code results
   - SCHEMA.md documenting task file format"
   ```
  </action>
  <verify>
- `ls ~/model-citizen-vault/.model-citizen/tasks/.gitkeep` exists
- `ls ~/model-citizen-vault/.model-citizen/outputs/.gitkeep` exists
- `cat ~/model-citizen-vault/.model-citizen/SCHEMA.md` shows task file documentation
- `git -C ~/model-citizen-vault log --oneline -1` shows commit
  </verify>
  <done>Task directories created with .gitkeep files, schema documented, committed to git</done>
</task>

<task type="auto">
  <name>Task 4: Create claude-task-runner.sh wrapper script</name>
  <files>~/model-citizen-vault/scripts/claude-task-runner.sh</files>
  <action>
Create the wrapper script that bridges n8n SSH calls to Claude Code execution.

Script requirements:
- Parse --task-file and --timeout arguments
- Validate task file exists and has required frontmatter
- Check idempotency (skip if output exists)
- Invoke `claude -p` with the task file content
- Write output atomically (temp file + rename)
- Capture and report errors with descriptive exit codes
- Use timeout command to prevent hangs

**Create ~/model-citizen-vault/scripts/claude-task-runner.sh:**

```bash
#!/bin/bash
# Claude Task Runner
# Wrapper script for n8n to invoke Claude Code via SSH
#
# Usage: claude-task-runner.sh --task-file <path> [--timeout 600]
#
# Exit codes:
#   0   - Success
#   1   - General error
#   2   - Invalid input (task file missing or malformed)
#   3   - Claude Code execution failed
#   124 - Timeout exceeded

set -euo pipefail

# Configuration
VAULT_DIR="$HOME/model-citizen-vault"
DEFAULT_TIMEOUT=600

# Script state
TASK_FILE=""
TIMEOUT=$DEFAULT_TIMEOUT
VERBOSE=false

# Colors (disabled if not terminal)
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
else
    RED=''
    GREEN=''
    YELLOW=''
    NC=''
fi

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1" >&2; }

usage() {
    cat << EOF
Usage: $0 --task-file <path> [--timeout <seconds>] [--verbose]

Options:
  --task-file <path>    Path to task file (required)
  --timeout <seconds>   Max execution time (default: $DEFAULT_TIMEOUT)
  --verbose             Enable verbose output
  --help                Show this help message

Exit codes:
  0   - Success
  1   - General error
  2   - Invalid input
  3   - Claude Code failed
  124 - Timeout exceeded
EOF
    exit 1
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --task-file)
            TASK_FILE="$2"
            shift 2
            ;;
        --timeout)
            TIMEOUT="$2"
            shift 2
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        --help)
            usage
            ;;
        *)
            log_error "Unknown option: $1"
            usage
            ;;
    esac
done

# Validate required arguments
if [[ -z "$TASK_FILE" ]]; then
    log_error "Missing required argument: --task-file"
    usage
fi

# Resolve task file path (handle relative paths)
if [[ ! "$TASK_FILE" = /* ]]; then
    TASK_FILE="$VAULT_DIR/$TASK_FILE"
fi

# Validate task file exists
if [[ ! -f "$TASK_FILE" ]]; then
    log_error "Task file not found: $TASK_FILE"
    exit 2
fi

log_info "Processing task file: $TASK_FILE"

# Extract frontmatter fields
extract_field() {
    local file="$1"
    local field="$2"
    grep "^${field}:" "$file" 2>/dev/null | head -1 | cut -d':' -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//;s/^"//;s/"$//'
}

TASK_ID=$(extract_field "$TASK_FILE" "task_id")
OUTPUT_PATH=$(extract_field "$TASK_FILE" "output_path")
TASK_TIMEOUT=$(extract_field "$TASK_FILE" "timeout")

# Use task-specific timeout if provided
if [[ -n "$TASK_TIMEOUT" ]]; then
    TIMEOUT=$TASK_TIMEOUT
fi

# Validate required fields
if [[ -z "$TASK_ID" ]]; then
    log_error "Task file missing required field: task_id"
    exit 2
fi

if [[ -z "$OUTPUT_PATH" ]]; then
    log_error "Task file missing required field: output_path"
    exit 2
fi

log_info "Task ID: $TASK_ID"
log_info "Output path: $OUTPUT_PATH"
log_info "Timeout: ${TIMEOUT}s"

# Resolve output path
if [[ ! "$OUTPUT_PATH" = /* ]]; then
    OUTPUT_FILE="$VAULT_DIR/$OUTPUT_PATH"
else
    OUTPUT_FILE="$OUTPUT_PATH"
fi

# Ensure output directory exists
OUTPUT_DIR=$(dirname "$OUTPUT_FILE")
mkdir -p "$OUTPUT_DIR"

# Idempotency check
if [[ -f "$OUTPUT_FILE" ]]; then
    log_warn "Output already exists (idempotent skip): $OUTPUT_FILE"
    exit 0
fi

# Temporary file for atomic write
TEMP_FILE="${OUTPUT_FILE}.tmp.$$"
ERROR_FILE="${OUTPUT_FILE}.err.$$"

# Cleanup on exit
cleanup() {
    rm -f "$TEMP_FILE" "$ERROR_FILE"
}
trap cleanup EXIT

log_info "Invoking Claude Code..."

# Read task file content for the prompt
TASK_CONTENT=$(cat "$TASK_FILE")

# Build the prompt
PROMPT="You are processing a task from an automated pipeline. Read the task specification below and execute it.

IMPORTANT:
- Output ONLY valid JSON (no markdown code blocks, no explanations)
- Follow the output format specified in the task
- If the task references a source file, read it using the Read tool

---
$TASK_CONTENT
---

Execute this task now and output the JSON result."

# Invoke Claude Code with timeout
# Using -p for print mode (non-interactive)
# Restricting tools to safe operations
set +e
timeout "$TIMEOUT" claude -p \
    --output-format text \
    --allowedTools "Read,Grep,Glob,WebFetch" \
    "$PROMPT" \
    > "$TEMP_FILE" 2> "$ERROR_FILE"

EXIT_CODE=$?
set -e

# Handle exit codes
if [[ $EXIT_CODE -eq 0 ]]; then
    # Verify output is valid JSON
    if python3 -c "import json; json.load(open('$TEMP_FILE'))" 2>/dev/null; then
        # Atomic rename
        mv "$TEMP_FILE" "$OUTPUT_FILE"
        log_info "Task completed successfully: $OUTPUT_FILE"
        exit 0
    else
        log_warn "Output is not valid JSON, saving as-is"
        mv "$TEMP_FILE" "$OUTPUT_FILE"
        log_info "Task completed (non-JSON output): $OUTPUT_FILE"
        exit 0
    fi
elif [[ $EXIT_CODE -eq 124 ]]; then
    log_error "Task timed out after ${TIMEOUT}s"
    if [[ -s "$ERROR_FILE" ]]; then
        cat "$ERROR_FILE" >&2
    fi
    exit 124
else
    log_error "Claude Code failed with exit code $EXIT_CODE"
    if [[ -s "$ERROR_FILE" ]]; then
        cat "$ERROR_FILE" >&2
    fi
    if [[ -s "$TEMP_FILE" ]]; then
        log_error "Partial output:"
        cat "$TEMP_FILE" >&2
    fi
    exit 3
fi
```

Make executable:
```bash
chmod +x ~/model-citizen-vault/scripts/claude-task-runner.sh
```

Commit:
```bash
cd ~/model-citizen-vault
git add scripts/claude-task-runner.sh
git commit -m "feat(06): add Claude Code wrapper script

- Parses --task-file and --timeout arguments
- Validates task file frontmatter (task_id, output_path)
- Idempotency check (skips if output exists)
- Timeout handling with exit code 124
- Atomic file writes (temp + rename)
- Restricted tools for safe automation"
```
  </action>
  <verify>
- `ls -la ~/model-citizen-vault/scripts/claude-task-runner.sh` shows executable permissions (-rwxr-xr-x)
- `~/model-citizen-vault/scripts/claude-task-runner.sh --help` shows usage information
- `git -C ~/model-citizen-vault log --oneline -1` shows wrapper script commit
  </verify>
  <done>Wrapper script created with argument parsing, idempotency, timeout handling, atomic writes, committed</done>
</task>

<task type="auto">
  <name>Task 5: Verify SSH connectivity from Docker to host</name>
  <files>None (verification only)</files>
  <action>
Test that the SSH infrastructure works end-to-end.

1. Test SSH from host to itself (basic verification):
   ```bash
   ssh -i ~/.ssh/n8n_docker -o StrictHostKeyChecking=no localhost "echo 'Host SSH works'"
   ```

2. Get the current username for n8n configuration:
   ```bash
   whoami
   ```

3. Test SSH using the hostname that Docker will use:
   ```bash
   # On macOS Docker Desktop, containers use host.docker.internal
   # But from host, we test with localhost
   ssh -i ~/.ssh/n8n_docker -o StrictHostKeyChecking=no localhost "echo 'SSH test: ' && hostname && whoami"
   ```

4. Test wrapper script invocation via SSH (simulates n8n):
   ```bash
   ssh -i ~/.ssh/n8n_docker localhost "~/model-citizen-vault/scripts/claude-task-runner.sh --help"
   ```

5. Document connection parameters for Plan 02:
   ```
   Host (from n8n container): host.docker.internal
   Port: 22
   Username: [output of whoami]
   Private key: ~/.ssh/n8n_docker (will need to mount into container)
   ```

If any step fails, troubleshoot:
- "Connection refused": Remote Login not enabled
- "Permission denied": Key not in authorized_keys or wrong permissions
- "Host key verification failed": Add -o StrictHostKeyChecking=no for automated use
  </action>
  <verify>
- SSH commands execute without password prompt
- Wrapper script help text appears via SSH
- Username captured for n8n configuration
  </verify>
  <done>SSH connectivity verified, wrapper script accessible via SSH, connection parameters documented</done>
</task>

</tasks>

<verification>
1. SSH key pair exists with correct permissions (600 for private, 644 for public)
2. Remote Login enabled on macOS (user verified)
3. `.model-citizen/tasks/` and `.model-citizen/outputs/` directories exist with .gitkeep
4. SCHEMA.md documents task file format with all required fields
5. claude-task-runner.sh is executable and shows help when invoked
6. SSH from localhost works without password prompt
7. Wrapper script can be invoked via SSH successfully
</verification>

<success_criteria>
- MC-08 (partial): SSH infrastructure ready for n8n integration
- MC-09: Claude Code wrapper CLI created with argument parsing, idempotency, timeout, atomic writes
- MC-10 (partial): Idempotency implemented in wrapper script (checks output existence)

**Quantitative:**
- 2 git commits in model-citizen-vault (directories + wrapper)
- 1 SSH key pair generated
- 1 wrapper script (80+ lines)
- 1 schema document
</success_criteria>

<output>
After completion, create `.planning/phases/06-claude-code-integration/06-01-SUMMARY.md`
</output>
