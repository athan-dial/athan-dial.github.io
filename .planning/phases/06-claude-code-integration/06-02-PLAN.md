---
phase: 06-claude-code-integration
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - ~/model-citizen-vault/.model-citizen/tasks/test-summarize-001.md
  - ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json
autonomous: true

must_haves:
  truths:
    - "n8n workflow can create task files in .model-citizen/tasks/"
    - "n8n SSH node successfully executes claude-task-runner.sh on host"
    - "Claude Code processes task and writes output to .model-citizen/outputs/"
    - "End-to-end flow completes without manual intervention"
    - "Re-running the same task skips processing (idempotent)"
  artifacts:
    - path: "~/model-citizen-vault/.model-citizen/tasks/test-summarize-001.md"
      provides: "Sample task file for testing"
      contains: "task_id"
    - path: "~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json"
      provides: "Claude Code output proving integration works"
      contains: "summary"
  key_links:
    - from: "n8n SSH node"
      to: "claude-task-runner.sh"
      via: "SSH command execution"
      pattern: "host.docker.internal"
    - from: "claude-task-runner.sh"
      to: ".model-citizen/outputs/"
      via: "file write"
      pattern: "test-summarize-001.json"
---

<objective>
Complete the n8n-to-Claude Code integration with a working end-to-end test.

Purpose: Prove the integration pattern works by processing a real task through the full pipeline: n8n creates task file -> SSH executes wrapper -> Claude Code processes -> output written.

Output:
- n8n workflow with SSH credential and task execution node
- Sample task file exercising the summarization use case
- Verified output from Claude Code
</objective>

<execution_context>
@/Users/adial/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adial/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-claude-code-integration/06-CONTEXT.md
@.planning/phases/06-claude-code-integration/06-RESEARCH.md
@.planning/phases/06-claude-code-integration/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sample task file for testing</name>
  <files>
    ~/model-citizen-vault/.model-citizen/tasks/test-summarize-001.md
  </files>
  <action>
Create a test task file that will exercise the Claude Code integration. Use an existing YouTube transcript from Phase 5 as the source, or create a simple test source if none exists.

1. First, check for existing content to summarize:
   ```bash
   ls ~/model-citizen-vault/sources/youtube/ 2>/dev/null || echo "No YouTube sources yet"
   ```

2. If no sources exist, create a simple test source:
   ```bash
   mkdir -p ~/model-citizen-vault/sources/test
   cat > ~/model-citizen-vault/sources/test/sample-content.md << 'EOF'
---
title: "Sample Content for Testing"
date: 2026-02-05
status: "inbox"
tags: []
source: "Test"
---

The Model Citizen project is an automated content pipeline that captures knowledge from various sources like YouTube videos, articles, and podcasts. It uses n8n for workflow orchestration and Claude Code for AI-driven synthesis tasks like summarization, tagging, and draft generation.

The key philosophy is "capture continuously, publish consciously" - the system ingests content automatically but requires explicit human approval before anything is published. This ensures quality while reducing manual effort in the capture and enrichment phases.

The architecture consists of:
1. A public Obsidian vault for raw material and thinking
2. A Quartz site for published content
3. n8n running in Docker for workflow automation
4. Claude Code invoked via SSH for AI synthesis

This approach separates concerns and allows each component to be updated independently.
EOF
   ```

3. Create the test task file:
   ```bash
   cat > ~/model-citizen-vault/.model-citizen/tasks/test-summarize-001.md << 'EOF'
---
task_id: "test-summarize-001"
task_type: "summarize"
created_at: "2026-02-05T15:00:00Z"
source_path: "sources/test/sample-content.md"
output_path: ".model-citizen/outputs/test-summarize-001.json"
timeout: 300
---

# Task: Summarize Test Content

Read the content at `sources/test/sample-content.md` and produce a JSON object with:

1. **summary**: A 2-3 sentence summary of the content
2. **themes**: An array of 3-5 key themes or topics covered
3. **tags**: An array of suggested tags for organizing this in a knowledge vault

Output format:
```json
{
  "task_id": "test-summarize-001",
  "task_type": "summarize",
  "completed_at": "<ISO timestamp>",
  "result": {
    "summary": "<2-3 sentences>",
    "themes": ["<theme1>", "<theme2>", ...],
    "tags": ["<tag1>", "<tag2>", ...]
  }
}
```

Read the source file first, then output ONLY the JSON result.
EOF
   ```

4. Commit the test files:
   ```bash
   cd ~/model-citizen-vault
   git add sources/test/ .model-citizen/tasks/
   git commit -m "test(06): add sample content and test task file

   - sources/test/sample-content.md for integration testing
   - test-summarize-001.md task to verify Claude Code wrapper"
   ```
  </action>
  <verify>
- `cat ~/model-citizen-vault/.model-citizen/tasks/test-summarize-001.md` shows task file with frontmatter
- `cat ~/model-citizen-vault/sources/test/sample-content.md` shows source content
- `git -C ~/model-citizen-vault log --oneline -1` shows commit
  </verify>
  <done>Test task file created with source content, committed to git</done>
</task>

<task type="auto">
  <name>Task 2: Execute wrapper script manually to verify Claude Code integration</name>
  <files>
    ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json
  </files>
  <action>
Run the wrapper script directly (not via SSH yet) to verify Claude Code integration works.

1. Run the wrapper script with the test task:
   ```bash
   ~/model-citizen-vault/scripts/claude-task-runner.sh \
       --task-file ~/model-citizen-vault/.model-citizen/tasks/test-summarize-001.md \
       --verbose
   ```

2. Check the output:
   ```bash
   cat ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json
   ```

3. Verify output structure (should have summary, themes, tags):
   ```bash
   python3 -c "
   import json
   with open('$HOME/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json') as f:
       data = json.load(f)
       print('task_id:', data.get('task_id', 'MISSING'))
       print('summary:', data.get('result', {}).get('summary', 'MISSING')[:100] + '...')
       print('themes:', data.get('result', {}).get('themes', 'MISSING'))
       print('tags:', data.get('result', {}).get('tags', 'MISSING'))
   "
   ```

4. Test idempotency (re-run should skip):
   ```bash
   ~/model-citizen-vault/scripts/claude-task-runner.sh \
       --task-file ~/model-citizen-vault/.model-citizen/tasks/test-summarize-001.md
   # Should print: "Output already exists (idempotent skip)"
   ```

If Claude Code fails:
- Check `claude --version` to verify installation
- Try `claude -p "Say hello" --output-format text` to test basic functionality
- Review error output for specific issues

5. Commit the output:
   ```bash
   cd ~/model-citizen-vault
   git add .model-citizen/outputs/
   git commit -m "feat(06): add test task output from Claude Code

   - Verified wrapper script invokes Claude Code successfully
   - Output contains summary, themes, and tags
   - Idempotency check confirmed"
   ```
  </action>
  <verify>
- Output file exists: `ls ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json`
- Output is valid JSON with expected structure
- Re-run shows "idempotent skip" message
- Output committed to git
  </verify>
  <done>Claude Code integration verified, output generated, idempotency confirmed</done>
</task>

<task type="auto">
  <name>Task 3: Test SSH invocation of wrapper script</name>
  <files>None (verification only, uses existing output)</files>
  <action>
Verify the wrapper script works when invoked via SSH (simulating what n8n will do).

1. First, remove the existing output to allow re-processing:
   ```bash
   rm ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json
   ```

2. Execute wrapper via SSH (simulating n8n container calling host):
   ```bash
   ssh -i ~/.ssh/n8n_docker -o StrictHostKeyChecking=no localhost \
       "~/model-citizen-vault/scripts/claude-task-runner.sh \
           --task-file ~/model-citizen-vault/.model-citizen/tasks/test-summarize-001.md"
   ```

3. Capture exit code:
   ```bash
   echo "Exit code: $?"
   ```

4. Verify output was created:
   ```bash
   ls -la ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json
   cat ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json | head -20
   ```

5. Test idempotency via SSH:
   ```bash
   ssh -i ~/.ssh/n8n_docker localhost \
       "~/model-citizen-vault/scripts/claude-task-runner.sh \
           --task-file ~/model-citizen-vault/.model-citizen/tasks/test-summarize-001.md"
   # Should show idempotent skip message
   ```

6. Document the SSH command for n8n configuration:
   ```
   SSH Command for n8n:
   ~/model-citizen-vault/scripts/claude-task-runner.sh --task-file {{ $json.task_file_path }}

   Connection parameters:
   - Host: host.docker.internal (from Docker container)
   - Port: 22
   - Username: [your username]
   - Auth: SSH key (mount ~/.ssh/n8n_docker into container)
   ```
  </action>
  <verify>
- SSH command executes without password prompt
- Output file is recreated after deletion
- Exit code is 0 on success
- Idempotency skip message appears on re-run
  </verify>
  <done>SSH invocation verified, wrapper script works via remote execution</done>
</task>

</tasks>

<verification>
1. Test task file exists with correct frontmatter (task_id, output_path, source_path)
2. Source content exists for the task to process
3. claude-task-runner.sh successfully invokes Claude Code
4. Output JSON contains expected structure (task_id, result with summary/themes/tags)
5. Idempotency works (re-run skips processing)
6. SSH invocation works (wrapper accessible via SSH)
7. All test artifacts committed to git

**Full integration test:**
```bash
# Clean slate
rm -f ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json

# SSH invocation (simulates n8n)
ssh -i ~/.ssh/n8n_docker localhost \
    "~/model-citizen-vault/scripts/claude-task-runner.sh \
        --task-file .model-citizen/tasks/test-summarize-001.md"

# Verify output
cat ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json | python3 -m json.tool
```
</verification>

<success_criteria>
- MC-08 (complete): n8n SSH integration proven to work (via SSH test)
- MC-09 (complete): Claude Code wrapper CLI processes tasks successfully
- MC-10 (complete): Agent invocation is idempotent (verified with re-run test)

**Quantitative:**
- 1 test task file created
- 1 source content file created
- 1 JSON output generated by Claude Code
- SSH invocation works with exit code 0
- Idempotency confirmed (skip on re-run)
</success_criteria>

<output>
After completion, create `.planning/phases/06-claude-code-integration/06-02-SUMMARY.md`
</output>
