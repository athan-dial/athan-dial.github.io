---
phase: 06-claude-code-integration
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - ~/model-citizen-vault/.model-citizen/tasks/test-summarize-001.md
  - ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json
  - ~/n8n-data/workflows/claude-code-ssh-test.json
  - ~/model-citizen-vault/.model-citizen/TASK-CREATION.md
autonomous: true

must_haves:
  truths:
    - "Task file exists in .model-citizen/tasks/ with valid frontmatter"
    - "Claude Code output JSON exists in .model-citizen/outputs/"
    - "n8n workflow with SSH node is importable and executes successfully"
    - "Full pipeline executes without manual intervention after trigger"
    - "Duplicate task execution is skipped (idempotent)"
  artifacts:
    - path: "~/model-citizen-vault/.model-citizen/tasks/test-summarize-001.md"
      provides: "Sample task file for testing"
      contains: "task_id"
    - path: "~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json"
      provides: "Claude Code output proving integration works"
      contains: "summary"
    - path: "~/n8n-data/workflows/claude-code-ssh-test.json"
      provides: "n8n workflow with SSH node configuration"
      contains: "ssh"
    - path: "~/model-citizen-vault/.model-citizen/TASK-CREATION.md"
      provides: "Documentation for how n8n creates task files"
      contains: "n8n"
  key_links:
    - from: "n8n SSH node"
      to: "claude-task-runner.sh"
      via: "SSH command execution"
      pattern: "host.docker.internal"
    - from: "claude-task-runner.sh"
      to: ".model-citizen/outputs/"
      via: "file write"
      pattern: "test-summarize-001.json"
    - from: "n8n workflow"
      to: ".model-citizen/tasks/"
      via: "Write File node or Function node"
      pattern: "task_id"
---

<objective>
Complete the n8n-to-Claude Code integration with a working end-to-end test and reusable workflow.

Purpose: Prove the integration pattern works by processing a real task through the full pipeline: n8n creates task file -> commits to Git -> SSH executes wrapper -> Claude Code processes -> output written. Also document the task creation pattern for future workflow builders.

Output:
- n8n workflow with SSH credential and task execution node (exportable JSON)
- Sample task file exercising the summarization use case
- Verified output from Claude Code
- Documentation for task file creation pattern
</objective>

<execution_context>
@/Users/adial/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adial/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-claude-code-integration/06-CONTEXT.md
@.planning/phases/06-claude-code-integration/06-RESEARCH.md
@.planning/phases/06-claude-code-integration/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sample task file and source content for testing</name>
  <files>
    ~/model-citizen-vault/.model-citizen/tasks/test-summarize-001.md
    ~/model-citizen-vault/sources/test/sample-content.md
  </files>
  <action>
Create a test task file that will exercise the Claude Code integration. Use an existing YouTube transcript from Phase 5 as the source, or create a simple test source if none exists.

1. First, check for existing content to summarize:
   ```bash
   ls ~/model-citizen-vault/sources/youtube/ 2>/dev/null || echo "No YouTube sources yet"
   ```

2. If no sources exist, create a simple test source:
   ```bash
   mkdir -p ~/model-citizen-vault/sources/test
   cat > ~/model-citizen-vault/sources/test/sample-content.md << 'EOF'
---
title: "Sample Content for Testing"
date: 2026-02-05
status: "inbox"
tags: []
source: "Test"
---

The Model Citizen project is an automated content pipeline that captures knowledge from various sources like YouTube videos, articles, and podcasts. It uses n8n for workflow orchestration and Claude Code for AI-driven synthesis tasks like summarization, tagging, and draft generation.

The key philosophy is "capture continuously, publish consciously" - the system ingests content automatically but requires explicit human approval before anything is published. This ensures quality while reducing manual effort in the capture and enrichment phases.

The architecture consists of:
1. A public Obsidian vault for raw material and thinking
2. A Quartz site for published content
3. n8n running in Docker for workflow automation
4. Claude Code invoked via SSH for AI synthesis

This approach separates concerns and allows each component to be updated independently.
EOF
   ```

3. Create the test task file:
   ```bash
   cat > ~/model-citizen-vault/.model-citizen/tasks/test-summarize-001.md << 'EOF'
---
task_id: "test-summarize-001"
task_type: "summarize"
created_at: "2026-02-05T15:00:00Z"
source_path: "sources/test/sample-content.md"
output_path: ".model-citizen/outputs/test-summarize-001.json"
timeout: 300
---

# Task: Summarize Test Content

Read the content at `sources/test/sample-content.md` and produce a JSON object with:

1. **summary**: A 2-3 sentence summary of the content
2. **themes**: An array of 3-5 key themes or topics covered
3. **tags**: An array of suggested tags for organizing this in a knowledge vault

Output format:
```json
{
  "task_id": "test-summarize-001",
  "task_type": "summarize",
  "completed_at": "<ISO timestamp>",
  "result": {
    "summary": "<2-3 sentences>",
    "themes": ["<theme1>", "<theme2>", ...],
    "tags": ["<tag1>", "<tag2>", ...]
  }
}
```

Read the source file first, then output ONLY the JSON result.
EOF
   ```

4. Commit the test files:
   ```bash
   cd ~/model-citizen-vault
   git add sources/test/ .model-citizen/tasks/
   git commit -m "test(06): add sample content and test task file

   - sources/test/sample-content.md for integration testing
   - test-summarize-001.md task to verify Claude Code wrapper"
   ```
  </action>
  <verify>
- `cat ~/model-citizen-vault/.model-citizen/tasks/test-summarize-001.md` shows task file with frontmatter
- `cat ~/model-citizen-vault/sources/test/sample-content.md` shows source content
- `git -C ~/model-citizen-vault log --oneline -1` shows commit
  </verify>
  <done>Test task file created with source content, committed to git</done>
</task>

<task type="auto">
  <name>Task 2: Document task file creation pattern for n8n workflows</name>
  <files>
    ~/model-citizen-vault/.model-citizen/TASK-CREATION.md
  </files>
  <action>
Document how n8n workflows should create task files. This is the reference for building future automation workflows.

**Create ~/model-citizen-vault/.model-citizen/TASK-CREATION.md:**

```markdown
# Task File Creation Guide for n8n Workflows

This document explains how n8n workflows create task files that Claude Code processes via SSH.

## Overview

The task creation pattern follows these steps:
1. **n8n generates task file** with frontmatter and instructions
2. **n8n commits to Vault** (ensures task is tracked in Git)
3. **n8n invokes SSH command** to run claude-task-runner.sh
4. **Claude Code processes** task and writes output
5. **n8n reads output** and continues workflow

## Task File Generation in n8n

### Option A: Function Node (Recommended)

Use a Function node to generate the task file content:

```javascript
// Generate unique task ID
const taskId = `${$input.item.json.source_type}-${Date.now()}`;
const now = new Date().toISOString();

// Build task file content
const taskContent = `---
task_id: "${taskId}"
task_type: "${$input.item.json.task_type || 'summarize'}"
created_at: "${now}"
source_path: "${$input.item.json.source_path}"
output_path: ".model-citizen/outputs/${taskId}.json"
timeout: ${$input.item.json.timeout || 300}
---

# Task: ${$input.item.json.task_title || 'Process Content'}

${$input.item.json.instructions}

Output as JSON following the schema in SCHEMA.md.
`;

return {
  json: {
    task_id: taskId,
    task_file_path: `.model-citizen/tasks/${taskId}.md`,
    task_content: taskContent,
    output_path: `.model-citizen/outputs/${taskId}.json`
  }
};
```

### Option B: Template Node

Use a Set node with expressions:

- **task_id**: `{{ 'yt-' + $now.toMillis() }}`
- **task_content**: Multi-line template with YAML frontmatter

## Writing Task File to Vault

### Using SSH + Echo (Simple)

```bash
ssh user@host.docker.internal "cat > ~/model-citizen-vault/.model-citizen/tasks/{{ $json.task_id }}.md << 'TASKEOF'
{{ $json.task_content }}
TASKEOF"
```

### Using n8n's Write Binary File Node

1. Convert task content to binary
2. Write to mounted volume (if Vault is accessible)
3. Or use SSH to write

## Committing to Git

After writing the task file, commit it:

```bash
ssh user@host.docker.internal "cd ~/model-citizen-vault && git add .model-citizen/tasks/{{ $json.task_id }}.md && git commit -m 'task: {{ $json.task_id }}'"
```

## Invoking Claude Code

After task file is committed:

```bash
ssh user@host.docker.internal "~/model-citizen-vault/scripts/claude-task-runner.sh --task-file .model-citizen/tasks/{{ $json.task_id }}.md"
```

## Reading Output

After SSH returns success (exit code 0):

```bash
ssh user@host.docker.internal "cat ~/model-citizen-vault/.model-citizen/outputs/{{ $json.task_id }}.json"
```

Parse the JSON response in a subsequent Function node.

## Complete n8n Workflow Pattern

```
[Trigger]
    -> [Function: Generate Task]
    -> [SSH: Write Task File]
    -> [SSH: Git Commit]
    -> [SSH: Run Claude Task Runner]
    -> [SSH: Read Output]
    -> [Function: Parse JSON]
    -> [Continue Workflow...]
```

## SSH Credential Configuration

In n8n, create an SSH credential with:
- **Host**: `host.docker.internal` (from Docker container)
- **Port**: `22`
- **Username**: Your macOS username
- **Private Key**: Contents of `~/.ssh/n8n_docker`

## Idempotency

The claude-task-runner.sh script checks if output already exists:
- If output exists: Returns immediately (exit 0, logs "idempotent skip")
- If output missing: Processes task normally

This means re-running the same workflow is safe.

## Error Handling

Check SSH exit codes:
- `0`: Success
- `2`: Invalid task file (missing fields)
- `3`: Claude Code failed
- `124`: Timeout

Use n8n's IF node to branch on exit code.

## Example: YouTube Summarization Workflow

```
[YouTube RSS Trigger]
    -> [HTTP: Fetch Transcript]
    -> [Function: Save Transcript to Vault]
    -> [Function: Generate Summarize Task]
    -> [SSH: Write + Commit + Execute]
    -> [SSH: Read Output]
    -> [Function: Update Note with Summary]
    -> [SSH: Commit Updated Note]
```
```

Commit the documentation:
```bash
cd ~/model-citizen-vault
git add .model-citizen/TASK-CREATION.md
git commit -m "docs(06): add task creation guide for n8n workflows

- Step-by-step pattern for generating task files
- Function node examples for task ID generation
- SSH command patterns for write, commit, execute
- Complete workflow pattern reference"
```
  </action>
  <verify>
- `cat ~/model-citizen-vault/.model-citizen/TASK-CREATION.md` shows task creation documentation
- `grep "n8n" ~/model-citizen-vault/.model-citizen/TASK-CREATION.md` confirms n8n-specific content
- `git -C ~/model-citizen-vault log --oneline -1` shows commit
  </verify>
  <done>Task creation pattern documented with n8n examples, committed to git</done>
</task>

<task type="auto">
  <name>Task 3: Execute wrapper script and create n8n workflow export</name>
  <files>
    ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json
    ~/n8n-data/workflows/claude-code-ssh-test.json
  </files>
  <action>
Run the wrapper script to verify Claude Code integration, then create an exportable n8n workflow.

**Part A: Execute wrapper script manually**

1. Run the wrapper script with the test task:
   ```bash
   ~/model-citizen-vault/scripts/claude-task-runner.sh \
       --task-file ~/model-citizen-vault/.model-citizen/tasks/test-summarize-001.md \
       --verbose
   ```

2. Check the output:
   ```bash
   cat ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json
   ```

3. Verify output structure (should have summary, themes, tags):
   ```bash
   python3 -c "
   import json
   with open('$HOME/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json') as f:
       data = json.load(f)
       print('task_id:', data.get('task_id', 'MISSING'))
       print('summary:', data.get('result', {}).get('summary', 'MISSING')[:100] + '...')
       print('themes:', data.get('result', {}).get('themes', 'MISSING'))
       print('tags:', data.get('result', {}).get('tags', 'MISSING'))
   "
   ```

4. Test idempotency (re-run should skip):
   ```bash
   ~/model-citizen-vault/scripts/claude-task-runner.sh \
       --task-file ~/model-citizen-vault/.model-citizen/tasks/test-summarize-001.md
   # Should print: "Output already exists (idempotent skip)"
   ```

If Claude Code fails:
- Check `claude --version` to verify installation
- Try `claude -p "Say hello" --output-format text` to test basic functionality
- Review error output for specific issues

**Part B: Create n8n workflow JSON export**

Create a portable n8n workflow that can be imported. This workflow demonstrates the SSH integration pattern.

```bash
mkdir -p ~/n8n-data/workflows
cat > ~/n8n-data/workflows/claude-code-ssh-test.json << 'EOF'
{
  "name": "Claude Code SSH Test",
  "nodes": [
    {
      "parameters": {},
      "id": "trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "jsCode": "// Generate task file content\nconst taskId = 'test-summarize-001';\nconst now = new Date().toISOString();\n\nreturn {\n  json: {\n    task_id: taskId,\n    task_file_path: `.model-citizen/tasks/${taskId}.md`,\n    output_path: `.model-citizen/outputs/${taskId}.json`,\n    ssh_command: `~/model-citizen-vault/scripts/claude-task-runner.sh --task-file .model-citizen/tasks/${taskId}.md`\n  }\n};"
      },
      "id": "generate-task",
      "name": "Generate Task Params",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "operation": "executeCommand",
        "command": "={{ $json.ssh_command }}"
      },
      "id": "ssh-execute",
      "name": "SSH Execute Claude",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [680, 300],
      "credentials": {
        "sshPassword": {
          "id": "REPLACE_WITH_CREDENTIAL_ID",
          "name": "macOS Host SSH"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeCommand",
        "command": "=cat ~/model-citizen-vault/{{ $json.output_path }}"
      },
      "id": "ssh-read-output",
      "name": "SSH Read Output",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [900, 300],
      "credentials": {
        "sshPassword": {
          "id": "REPLACE_WITH_CREDENTIAL_ID",
          "name": "macOS Host SSH"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse Claude Code output\nconst output = $input.first().json.stdout;\ntry {\n  const result = JSON.parse(output);\n  return { json: result };\n} catch (e) {\n  return { json: { error: 'Failed to parse output', raw: output } };\n}"
      },
      "id": "parse-output",
      "name": "Parse JSON Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 300]
    }
  ],
  "connections": {
    "Manual Trigger": {
      "main": [
        [{ "node": "Generate Task Params", "type": "main", "index": 0 }]
      ]
    },
    "Generate Task Params": {
      "main": [
        [{ "node": "SSH Execute Claude", "type": "main", "index": 0 }]
      ]
    },
    "SSH Execute Claude": {
      "main": [
        [{ "node": "SSH Read Output", "type": "main", "index": 0 }]
      ]
    },
    "SSH Read Output": {
      "main": [
        [{ "node": "Parse JSON Output", "type": "main", "index": 0 }]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": ["claude-code", "ssh", "integration-test"]
}
EOF
```

5. Commit the output:
   ```bash
   cd ~/model-citizen-vault
   git add .model-citizen/outputs/
   git commit -m "feat(06): add test task output from Claude Code

   - Verified wrapper script invokes Claude Code successfully
   - Output contains summary, themes, and tags
   - Idempotency check confirmed"
   ```

**Part C: Test SSH invocation (simulates n8n)**

1. Remove the existing output to allow re-processing:
   ```bash
   rm ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json
   ```

2. Execute wrapper via SSH (simulating n8n container calling host):
   ```bash
   ssh -i ~/.ssh/n8n_docker -o StrictHostKeyChecking=no localhost \
       "~/model-citizen-vault/scripts/claude-task-runner.sh \
           --task-file ~/model-citizen-vault/.model-citizen/tasks/test-summarize-001.md"
   echo "Exit code: $?"
   ```

3. Verify output was created:
   ```bash
   ls -la ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json
   cat ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json | head -20
   ```
  </action>
  <verify>
- Output file exists: `ls ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json`
- Output is valid JSON with expected structure
- Re-run shows "idempotent skip" message
- n8n workflow JSON exists: `ls ~/n8n-data/workflows/claude-code-ssh-test.json`
- SSH invocation completes with exit code 0
  </verify>
  <done>Claude Code integration verified, n8n workflow exported, SSH invocation confirmed</done>
</task>

</tasks>

<verification>
1. Test task file exists with correct frontmatter (task_id, output_path, source_path)
2. Source content exists for the task to process
3. Task creation documentation exists (TASK-CREATION.md)
4. claude-task-runner.sh successfully invokes Claude Code
5. Output JSON contains expected structure (task_id, result with summary/themes/tags)
6. Idempotency works (re-run skips processing)
7. SSH invocation works (wrapper accessible via SSH)
8. n8n workflow JSON is importable (valid JSON structure)
9. All test artifacts committed to git

**Full integration test:**
```bash
# Clean slate
rm -f ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json

# SSH invocation (simulates n8n)
ssh -i ~/.ssh/n8n_docker localhost \
    "~/model-citizen-vault/scripts/claude-task-runner.sh \
        --task-file .model-citizen/tasks/test-summarize-001.md"

# Verify output
cat ~/model-citizen-vault/.model-citizen/outputs/test-summarize-001.json | python3 -m json.tool
```
</verification>

<success_criteria>
- MC-08 (complete): n8n workflow with SSH node created and tested
- MC-09 (complete): Claude Code wrapper CLI processes tasks successfully
- MC-10 (complete): Agent invocation is idempotent (verified with re-run test)

**Quantitative:**
- 1 test task file created
- 1 source content file created
- 1 JSON output generated by Claude Code
- 1 n8n workflow JSON exported
- 1 task creation guide documented
- SSH invocation works with exit code 0
- Idempotency confirmed (skip on re-run)
</success_criteria>

<output>
After completion, create `.planning/phases/06-claude-code-integration/06-02-SUMMARY.md`
</output>
