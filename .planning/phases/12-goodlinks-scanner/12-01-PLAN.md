---
phase: 12-goodlinks-scanner
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/goodlinks-query.py
  - ~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/ingest-goodlinks.sh
autonomous: true
requirements: [DATA-01, DATA-02, DATA-03, INGS-01, INGS-02, INGS-03, INGS-04]

must_haves:
  truths:
    - "Running ingest-goodlinks.sh --dry-run lists GoodLinks items without writing files"
    - "Running ingest-goodlinks.sh creates Markdown notes in sources/goodlinks/ with correct YAML frontmatter"
    - "Re-running ingest-goodlinks.sh does not duplicate already-seen notes (state file tracks seen IDs)"
    - "Notes for links without content have content_status: pending in frontmatter"
    - "GoodLinks user tags appear in the note frontmatter tags list"
  artifacts:
    - path: "~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/goodlinks-query.py"
      provides: "SQLite query, note emission, state management, slug generation"
    - path: "~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/ingest-goodlinks.sh"
      provides: "Bash orchestrator — directory setup, Python invocation, dry-run flag"
    - path: "~/.model-citizen/goodlinks-state.json"
      provides: "Incremental scan state (last_scan_ts + seen_ids)"
  key_links:
    - from: "ingest-goodlinks.sh"
      to: "goodlinks-query.py"
      via: "Python subprocess invocation with --output-dir and optional --dry-run"
      pattern: "PYTHON.*goodlinks-query\\.py.*--output-dir"
    - from: "goodlinks-query.py"
      to: "GoodLinks SQLite DB"
      via: "sqlite3.connect with ?mode=ro URI"
      pattern: "sqlite3\\.connect.*mode=ro"
    - from: "goodlinks-query.py"
      to: "goodlinks-state.json"
      via: "JSON read/write for incremental cursor + seen_ids dedup"
      pattern: "goodlinks-state\\.json"
---

<objective>
Create the GoodLinks scanner: a Python script that reads the GoodLinks SQLite database and emits vault Markdown notes, wrapped by a bash orchestrator script.

Purpose: Enable manual ingestion of GoodLinks saved articles into the Model Citizen vault as source notes with proper frontmatter, tags, and content — runnable before any automation wiring (Phase 13).

Output: Two scripts (`goodlinks-query.py` + `ingest-goodlinks.sh`) and a state file pattern that together read GoodLinks data, create vault notes, and track progress incrementally.
</objective>

<execution_context>
@/Users/adial/.claude/get-shit-done/workflows/execute-plan.md
@/Users/adial/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-goodlinks-scanner/12-RESEARCH.md
@~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/ingest-youtube.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create goodlinks-query.py — Python core for SQLite query and note emission</name>
  <files>~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/goodlinks-query.py</files>
  <action>
Create `goodlinks-query.py` at the vault scripts directory. Use the complete code skeleton from 12-RESEARCH.md (Pattern sections + Code Examples) as the implementation reference. The script must:

1. **DB access (DATA-01):** Connect to GoodLinks SQLite at `~/Library/Group Containers/group.com.ngocluu.goodlinks/Data/data.sqlite` using `?mode=ro` URI for read-only access. Query `link` LEFT JOIN `content` filtering `status=0 AND deletedAt IS NULL AND addedAt > since_ts`.

2. **State management (DATA-02, DATA-03):** Load/save state from `~/.model-citizen/goodlinks-state.json` containing `last_scan_ts` (Unix float) and `seen_ids` (list of UUID strings). On load, compute `since_ts = last_scan_ts - LOOKBACK_SECONDS` (LOOKBACK=3600). First run default: `last_scan_ts = now - 30 days`. Skip links whose ID is in `seen_ids` set. After successful emission, update `last_scan_ts = now` and append new IDs to `seen_ids`.

3. **Note emission (INGS-01, INGS-02, INGS-03, INGS-04):** For each new link, write a Markdown file to `--output-dir` with YAML frontmatter: `title` (JSON-quoted), `date` (YYYY-MM-DD from addedAt), `status: inbox`, `tags` (JSON array from comma-split of link.tags or empty), `source: GoodLinks`, `source_url` (JSON-quoted), `goodlinks_id` (JSON-quoted), `starred` (true/false). Body = content table text. If no content row exists (~6% of links), add `content_status: pending` to frontmatter and write placeholder body text.

4. **Filename (slug):** `make_slug(title)` — lowercase, strip non-alphanumeric, spaces to hyphens, max 60 chars. If `outfile.exists()`, append `-{id[:8]}` suffix to avoid collision.

5. **CLI:** `argparse` with `--output-dir` (required) and `--dry-run` (optional, prints but doesn't write files or update state).

6. **Shebang:** `#!/usr/bin/env /opt/homebrew/bin/python3.12`. Add `encoding='utf-8'` to `write_text()` calls.

Print summary: "Found X links since lookback window, Y new" and per-note "Created: {filename}" lines.
  </action>
  <verify>
Run: `/opt/homebrew/bin/python3.12 ~/Library/Mobile\ Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/goodlinks-query.py --output-dir /tmp/gl-test --dry-run`

Expected: prints link count and filenames without creating files in /tmp/gl-test. Exit code 0. No import errors.
  </verify>
  <done>goodlinks-query.py exists, is executable, runs --dry-run without errors, and reports GoodLinks link counts from live DB</done>
</task>

<task type="auto">
  <name>Task 2: Create ingest-goodlinks.sh bash wrapper and verify end-to-end</name>
  <files>~/Library/Mobile Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/ingest-goodlinks.sh</files>
  <action>
Create `ingest-goodlinks.sh` at the vault scripts directory. Follow the `ingest-youtube.sh` pattern for structure consistency:

1. `set -euo pipefail` header
2. Define `VAULT_DIR`, `OUTPUT_DIR` (sources/goodlinks), `SCRIPT_DIR`, `PYTHON` (/opt/homebrew/bin/python3.12)
3. `mkdir -p "$OUTPUT_DIR"`
4. Pass `--dry-run` flag through if `$1` is `--dry-run`
5. Call: `"$PYTHON" "$SCRIPT_DIR/goodlinks-query.py" --output-dir "$OUTPUT_DIR" $DRY_RUN`
6. Print "GoodLinks scan complete"
7. `chmod +x` both scripts

Then verify end-to-end:
- Run `ingest-goodlinks.sh --dry-run` to confirm bash→Python chain works
- Run `ingest-goodlinks.sh` (real run) to create actual vault notes
- Verify at least one .md file exists in `sources/goodlinks/` with correct frontmatter (title, date, status, tags, source, source_url, goodlinks_id fields present)
- Verify `~/.model-citizen/goodlinks-state.json` exists with `last_scan_ts` and `seen_ids`
- Run `ingest-goodlinks.sh` again and confirm 0 new notes created (idempotency check)
  </action>
  <verify>
1. `bash ~/Library/Mobile\ Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/ingest-goodlinks.sh --dry-run` exits 0
2. `bash ~/Library/Mobile\ Documents/iCloud~md~obsidian/Documents/model-citizen-vault/scripts/ingest-goodlinks.sh` creates notes in sources/goodlinks/
3. `head -15 ~/Library/Mobile\ Documents/iCloud~md~obsidian/Documents/model-citizen-vault/sources/goodlinks/*.md | head -30` shows valid YAML frontmatter
4. `cat ~/.model-citizen/goodlinks-state.json` shows last_scan_ts and seen_ids
5. Re-run reports "0 new" — no duplicates
  </verify>
  <done>ingest-goodlinks.sh creates vault notes with correct frontmatter from GoodLinks data, tracks state for incremental scanning, and produces no duplicates on re-run</done>
</task>

</tasks>

<verification>
1. `goodlinks-query.py` and `ingest-goodlinks.sh` exist in vault scripts directory and are executable
2. Dry-run mode works without side effects
3. Real run creates .md files in `sources/goodlinks/` with all required frontmatter fields
4. State file at `~/.model-citizen/goodlinks-state.json` persists between runs
5. Second run produces 0 new notes (idempotency via seen_ids)
6. Notes for links without content have `content_status: pending` in frontmatter
</verification>

<success_criteria>
- Running `ingest-goodlinks.sh` manually creates Markdown vault notes in `sources/goodlinks/` for recently saved GoodLinks items
- Each note has correct YAML frontmatter (title, url, source, date, tags, status) drawn from GoodLinks data
- GoodLinks user-applied tags appear in note frontmatter tag list
- Re-running does not create duplicates (state file dedup)
- Lookback buffer ensures late-arriving iCloud-synced items are captured on next run
</success_criteria>

<output>
After completion, create `.planning/phases/12-goodlinks-scanner/12-01-SUMMARY.md`
</output>
